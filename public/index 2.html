<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-green { color: #10b981; }
        .status-yellow { color: #f59e0b; }
        .status-red { color: #ef4444; }
        
        /* VIGL Discovery Card Styles */
        .vigl-discovery-card {
            transition: all 0.3s ease;
        }
        .vigl-discovery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* Action Badge Styles */
        .action-buy { @apply bg-green-600 text-green-100; }
        .action-watchlist { @apply bg-yellow-600 text-yellow-100; }
        .action-monitor { @apply bg-blue-600 text-blue-100; }
        
        /* Score Bar */
        .vigl-score-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            height: 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-6">
        
        <!-- Header -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">üéØ Trading Intelligence Dashboard</h1>
                    <p class="text-blue-200">Unified VIGL Discovery + Portfolio Management</p>
                </div>
                <div class="flex space-x-4">
                    <button id="refreshBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors">
                        üîÑ Refresh
                    </button>
                    <button id="analyzeBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                        üß† Analyze
                    </button>
                </div>
            </div>
            
            <!-- Status Indicators -->
            <div class="flex items-center space-x-6 mt-4 text-sm">
                <div class="flex items-center">
                    <div id="connectionDot" class="w-3 h-3 rounded-full mr-2 pulse-dot status-yellow"></div>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div id="lastUpdated" class="text-blue-200">Last updated: --</div>
                <div id="loadingIndicator" class="hidden">
                    <span class="inline-block animate-spin">‚ö°</span> Loading...
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center mb-2">
                    <div class="text-2xl mr-3">üí∞</div>
                    <div>
                        <div class="text-2xl font-bold" id="totalValue">$--</div>
                        <div class="text-blue-200 text-sm">Portfolio Value</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center mb-2">
                    <div class="text-2xl mr-3">üìà</div>
                    <div>
                        <div class="text-2xl font-bold" id="dailyPnL">$--</div>
                        <div class="text-blue-200 text-sm">Today's P&L</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center mb-2">
                    <div class="text-2xl mr-3">üíé</div>
                    <div>
                        <div class="text-2xl font-bold" id="totalPnL">$--</div>
                        <div class="text-blue-200 text-sm">Total P&L</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center mb-2">
                    <div class="text-2xl mr-3">üìä</div>
                    <div>
                        <div class="text-2xl font-bold" id="totalPnLPercent">--%</div>
                        <div class="text-blue-200 text-sm">Total Return</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- VIGL Discoveries - Rebuilt -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold mb-1">üîç VIGL Pattern Discoveries</h2>
                            <p class="text-blue-200 text-xs">Optimized pattern recognition system</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="scanViglBtn" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg font-medium transition-colors flex items-center">
                                <span id="viglScanIcon">üîç</span>
                                <span id="viglScanText" class="ml-1 text-sm">Scan Market</span>
                            </button>
                            <button id="clearViglBtn" class="bg-gray-600 hover:bg-gray-700 px-2 py-2 rounded-lg text-xs transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>

                    <!-- Discovery Stats -->
                    <div id="viglStats" class="grid grid-cols-4 gap-2 mb-4">
                        <div class="bg-gray-800 bg-opacity-50 rounded-md p-2 text-center">
                            <div class="text-lg font-bold" id="viglTotalDiscoveries">0</div>
                            <div class="text-xs text-blue-300">Found</div>
                        </div>
                        <div class="bg-gray-800 bg-opacity-50 rounded-md p-2 text-center">
                            <div class="text-lg font-bold text-green-400" id="viglBuyCount">0</div>
                            <div class="text-xs text-blue-300">BUY</div>
                        </div>
                        <div class="bg-gray-800 bg-opacity-50 rounded-md p-2 text-center">
                            <div class="text-lg font-bold text-yellow-400" id="viglWatchlistCount">0</div>
                            <div class="text-xs text-blue-300">Watch</div>
                        </div>
                        <div class="bg-gray-800 bg-opacity-50 rounded-md p-2 text-center">
                            <div class="text-lg font-bold text-blue-400" id="viglMonitorCount">0</div>
                            <div class="text-xs text-blue-300">Monitor</div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="flex items-center space-x-3 mb-4 text-xs">
                        <label class="flex items-center space-x-1">
                            <input type="checkbox" id="viglFilterBuy" checked class="rounded">
                            <span>BUY</span>
                        </label>
                        <label class="flex items-center space-x-1">
                            <input type="checkbox" id="viglFilterWatchlist" checked class="rounded">
                            <span>WATCH</span>
                        </label>
                        <label class="flex items-center space-x-1">
                            <input type="checkbox" id="viglFilterMonitor" checked class="rounded">
                            <span>MON</span>
                        </label>
                        <div class="ml-auto flex items-center space-x-1">
                            <span>Score:</span>
                            <input type="range" id="viglMinScoreSlider" min="0" max="100" value="10" class="w-16">
                            <span id="viglMinScoreValue" class="font-bold">10</span>
                        </div>
                    </div>

                    <!-- Discoveries Container - Upgraded -->
                    <div id="discoveries" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                        <!-- Discovery tiles will be rendered here via renderDiscoveryTiles.js -->
                    </div>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div>
                <div class="glass-effect rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üö® Recent Alerts</h2>
                    <div id="recentAlerts" class="space-y-3">
                        <div class="text-center text-blue-200 py-4">
                            No alerts yet...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Positions -->
        <div class="mt-6">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üìä Portfolio Positions</h2>
                    <button id="analyzePortfolioBtn" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm transition-colors">
                        Analyze Risk
                    </button>
                </div>
                
                <div id="portfolioPositions" class="space-y-4">
                    <div class="text-center text-blue-200 py-8">
                        Loading portfolio positions...
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Health Dashboard -->
        <div class="mt-6">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üíä Portfolio Health Analysis</h2>
                    <div class="flex items-center space-x-2">
                        <span id="healthScore" class="text-sm font-bold px-3 py-1 rounded bg-gray-700">--</span>
                        <span id="healthStatus" class="text-2xl">‚ö™</span>
                    </div>
                </div>
                
                <!-- Health Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3">
                        <div class="text-xs text-blue-300 mb-1">Win Rate</div>
                        <div class="text-xl font-bold" id="winRate">--%</div>
                    </div>
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3">
                        <div class="text-xs text-blue-300 mb-1">Best Performer</div>
                        <div class="text-xl font-bold text-green-400" id="bestPerformer">--</div>
                    </div>
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3">
                        <div class="text-xs text-blue-300 mb-1">Risk Level</div>
                        <div class="text-xl font-bold" id="riskLevel">--</div>
                    </div>
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3">
                        <div class="text-xs text-blue-300 mb-1">Volatility</div>
                        <div class="text-xl font-bold" id="volatility">--%</div>
                    </div>
                </div>
                
                <!-- Strategic Outlook -->
                <div class="bg-gray-800 bg-opacity-30 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-bold mb-2 flex items-center">
                        <span class="mr-2">üéØ</span>
                        Strategic Outlook
                        <span id="outlookSentiment" class="ml-2 text-sm px-2 py-1 rounded bg-gray-700">--</span>
                    </h3>
                    <div id="outlookSummary" class="text-blue-200 text-sm mb-2">Loading analysis...</div>
                    <div class="text-xs text-blue-300">
                        <span class="mr-4">Focus Areas: <span id="keyFocus">--</span></span>
                        <span>Timeframe: <span id="timeframe">--</span></span>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div id="recommendationsSection" class="space-y-2">
                    <h3 class="text-lg font-bold mb-2">üìã Action Recommendations</h3>
                    <div id="recommendations">
                        <div class="text-center text-blue-200 py-4">Loading recommendations...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Opportunities -->
        <div class="mt-6">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-xl font-bold mb-4">üöÄ Trading Opportunities</h2>
                <div id="opportunities" class="space-y-3">
                    <div class="text-center text-blue-200 py-4">Loading opportunities...</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modalTitle">Execute Trade</h3>
                <button onclick="closeTradeModal()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-1">Action</label>
                    <div class="text-lg font-bold" id="modalAction">BUY</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-1">Symbol</label>
                    <div class="text-lg font-bold" id="modalSymbol">--</div>
                </div>
                
                <div>
                    <label for="tradeDollarAmount" class="block text-sm font-medium text-blue-200 mb-1">Dollar Amount</label>
                    <input type="number" id="tradeDollarAmount" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white" 
                           min="1" max="100000" value="1000" step="100">
                </div>
                
                <div>
                    <label for="tradeQuantity" class="block text-sm font-medium text-blue-200 mb-1">Shares (auto-calculated)</label>
                    <input type="number" id="tradeQuantity" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white" 
                           min="1" max="1000" value="10" readonly>
                
                <div class="bg-blue-900 bg-opacity-30 rounded p-3 space-y-2">
                    <div class="text-xs text-blue-200">Current Price: <span id="modalPrice">$--</span></div>
                    <div class="text-xs text-blue-200">Estimated Cost: $<span id="estimatedCost">--</span></div>
                    <hr class="border-blue-700">
                    <div class="text-xs text-blue-200">üéØ Entry Target: <span id="entryTarget" class="text-green-400">$--</span></div>
                    <div class="text-xs text-blue-200">üõ°Ô∏è Stop Loss: <span id="stopLoss" class="text-red-400">$--</span></div>
                    <div class="text-xs text-blue-200">üìà Price Target: <span id="priceTarget" class="text-yellow-400">$--</span></div>
                    <div class="text-xs text-blue-200">‚è∞ Timeline: <span id="timeline" class="text-blue-300">--</span></div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeTradeModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded transition-colors">
                        Cancel
                    </button>
                    <button onclick="executeTrade()" id="executeBtn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded font-medium transition-colors">
                        Execute Trade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TradingDashboard {
            constructor() {
                this.data = {};
                this.refreshInterval = null;
                this.initializeEventListeners();
                this.loadDashboard();
                this.startAutoRefresh();
            }

            initializeEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadDashboard());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.runAnalysis());
                document.getElementById('analyzePortfolioBtn').addEventListener('click', () => this.analyzePortfolio());
                
                // Initialize VIGL Discovery System
                this.initVIGLDiscoverySystem();
            }

            initVIGLDiscoverySystem() {
                // Bind VIGL scan button
                const scanBtn = document.getElementById('scanViglBtn');
                const clearBtn = document.getElementById('clearViglBtn');
                
                if (scanBtn) {
                    scanBtn.addEventListener('click', () => this.scanViglPatterns());
                }
                
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearViglDiscoveries());
                }

                // Bind filter controls
                const filterControls = [
                    'viglFilterBuy',
                    'viglFilterWatchlist', 
                    'viglFilterMonitor',
                    'viglMinScoreSlider'
                ];

                filterControls.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', () => this.updateViglFilters());
                    }
                });

                // Load initial VIGL discoveries
                this.loadViglDiscoveries();
            }

            clearViglDiscoveries() {
                const container = document.getElementById('viglDiscoveries');
                container.innerHTML = `
                    <div id="viglEmptyState" class="text-center py-8">
                        <div class="text-4xl mb-3">üîç</div>
                        <h3 class="text-lg font-bold mb-2">Ready to Discover VIGL Patterns</h3>
                        <p class="text-blue-200 text-sm mb-4">Click "Scan Market" to analyze for volume spikes and momentum</p>
                        <div class="bg-blue-900 bg-opacity-30 rounded-lg p-3 text-xs text-blue-300">
                            üéØ Scanning for 20.9x volume spikes like VIGL's 324% winner
                        </div>
                    </div>
                `;
                this.updateViglStats(0, 0, 0, 0);
            }

            updateViglFilters() {
                // Re-render discoveries with current filters
                this.renderViglDiscoveries();
            }

            updateViglStats(total, buyCount, watchlistCount, monitorCount) {
                document.getElementById('viglTotalDiscoveries').textContent = total;
                document.getElementById('viglBuyCount').textContent = buyCount;
                document.getElementById('viglWatchlistCount').textContent = watchlistCount;
                document.getElementById('viglMonitorCount').textContent = monitorCount;
                
                // Update slider value display
                const slider = document.getElementById('viglMinScoreSlider');
                const valueDisplay = document.getElementById('viglMinScoreValue');
                if (slider && valueDisplay) {
                    valueDisplay.textContent = slider.value;
                }
            }

            async loadDashboard() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/dashboard');
                    
                    if (!response.ok) throw new Error('Failed to load dashboard');
                    
                    this.data = await response.json();
                    
                    // Load discoveries from new endpoint
                    await this.loadTodaysDiscoveries();
                    await this.loadViglDiscoveries();
                    
                    this.updateUI();
                    this.updateConnectionStatus(this.data.portfolio?.isConnected);
                    
                } catch (error) {
                    console.error('Dashboard load error:', error);
                    this.showError('Failed to load dashboard data');
                    this.updateConnectionStatus(false);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async loadTodaysDiscoveries() {
                try {
                    const response = await fetch('/api/discoveries/top');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.data.discoveries = result.discoveries;
                        console.log(`‚úÖ Loaded ${result.count} discoveries from SQLite`);
                    }
                } catch (error) {
                    console.error('Failed to load discoveries:', error);
                    this.data.discoveries = [];
                }
            }

            async loadViglDiscoveries() {
                try {
                    const response = await fetch('/api/discoveries/dashboard');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.data.viglDiscoveries = result.discoveries.map(d => ({
                            symbol: d.ticker,
                            name: d.name,
                            currentPrice: d.price,
                            score: d.score,
                            action: d.action,
                            volumeSpike: d.volumeX,
                            estimatedUpside: d.score >= 75 ? '100-200%' : d.score >= 60 ? '50-100%' : '25-50%',
                            timeline: d.score >= 85 ? '3-6 months' : d.score >= 75 ? '2-4 months' : '1-3 months',
                            catalysts: d.catalyst ? [d.catalyst.type] : ['VIGL Pattern'],
                            riskLevel: d.score >= 70 ? 'MODERATE' : 'HIGH',
                            positionSize: d.score >= 85 ? 'LARGE' : d.score >= 75 ? 'MEDIUM' : 'SMALL',
                            recommendedQuantity: Math.max(1, Math.floor(1000 / d.price)),
                            isHighConfidence: d.isHighConfidence,
                            targetPrices: d.targetPrices || { moderate: d.price * 1.2 },
                            explosivenessScore: d.explosivenessScore
                        }));
                        
                        const buyCount = this.data.viglDiscoveries.filter(d => d.action === 'BUY').length;
                        const watchlistCount = this.data.viglDiscoveries.filter(d => d.action === 'WATCHLIST').length;
                        const monitorCount = this.data.viglDiscoveries.filter(d => d.action === 'MONITOR').length;
                        
                        this.updateViglStats(
                            this.data.viglDiscoveries.length,
                            buyCount,
                            watchlistCount, 
                            monitorCount
                        );
                        this.renderViglDiscoveries();
                        console.log(`‚úÖ Loaded ${this.data.viglDiscoveries.length} enriched VIGL discoveries`);
                    } else {
                        this.data.viglDiscoveries = [];
                        this.updateViglStats(0, 0, 0, 0);
                    }
                } catch (error) {
                    console.error('Failed to load VIGL discoveries:', error);
                    this.data.viglDiscoveries = [];
                    this.updateViglStats(0, 0, 0, 0);
                }
            }

            async runAnalysis() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'both' })
                    });
                    
                    if (!response.ok) throw new Error('Analysis failed');
                    
                    const result = await response.json();
                    this.showSuccess('Analysis complete!');
                    
                    // Refresh dashboard with new data
                    setTimeout(() => this.loadDashboard(), 1000);
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showError('Analysis failed');
                } finally {
                    this.showLoading(false);
                }
            }

            async scanViglPatterns() {
                try {
                    // Update UI to show scanning state
                    this.showViglScanning(true);
                    this.showSuccess('Running VIGL discovery scan...');
                    
                    const response = await fetch('/api/trigger-vigl-scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            symbols: null, // Scan entire market
                            options: {
                                verbose: false
                            }
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Reload VIGL discoveries from new endpoint
                        await this.loadViglDiscoveries();
                        
                        if (result.count > 0) {
                            this.showSuccess(`‚úÖ VIGL scan complete! Found ${result.count} moonshot patterns.`);
                        } else {
                            this.showSuccess('Scan complete. No VIGL patterns found matching criteria.');
                        }
                    } else {
                        throw new Error(result.error || 'VIGL scan failed');
                    }
                    
                } catch (error) {
                    console.error('VIGL discovery scan error:', error);
                    this.showError(error.message || 'VIGL scan failed');
                } finally {
                    this.showViglScanning(false);
                }
            }

            showViglScanning(scanning) {
                const container = document.getElementById('viglDiscoveries');
                const scanBtn = document.getElementById('scanViglBtn');
                
                if (scanning) {
                    scanBtn.disabled = true;
                    scanBtn.textContent = '‚è≥ Scanning...';
                    scanBtn.className = 'bg-gray-600 px-3 py-1 rounded text-sm cursor-not-allowed';
                    
                    container.innerHTML = `
                        <div class="text-center text-blue-200 py-8">
                            <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-blue-400 rounded-full mb-4"></div>
                            <div class="text-lg font-bold mb-2">üîç VIGL Pattern Analysis Running</div>
                            <div class="text-sm">Scanning thousands of stocks for volume spikes and momentum patterns...</div>
                            <div class="text-xs text-blue-300 mt-2">‚è±Ô∏è This process takes 1-2 minutes - please don't refresh the page</div>
                            <div class="mt-4 bg-blue-900 bg-opacity-50 rounded-lg p-3">
                                <div class="text-xs">Looking for patterns similar to VIGL's 324% winner:</div>
                                <div class="text-xs">‚Ä¢ 20.9x volume spikes ‚Ä¢ Price momentum ‚Ä¢ Breakout patterns</div>
                            </div>
                        </div>
                    `;
                } else {
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'Scan Market';
                    scanBtn.className = 'bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm transition-colors';
                }
            }

            async analyzePortfolio() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'portfolio' })
                    });
                    
                    if (!response.ok) throw new Error('Portfolio analysis failed');
                    
                    const result = await response.json();
                    this.data.portfolio = result.portfolio;
                    this.renderPortfolioPositions();
                    this.showSuccess('Portfolio analysis complete!');
                    
                } catch (error) {
                    console.error('Portfolio analysis error:', error);
                    this.showError('Portfolio analysis failed');
                } finally {
                    this.showLoading(false);
                }
            }

            updateUI() {
                if (!this.data.summary) return;

                const { summary } = this.data;
                
                // Helper functions for formatting
                const formatCurrency = (val) => {
                    const num = parseFloat(val) || 0;
                    const prefix = num < 0 ? '-$' : '$';
                    return prefix + Math.abs(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };
                
                const formatPercent = (val) => {
                    const num = parseFloat(val) || 0;
                    const prefix = num >= 0 ? '+' : '';
                    return prefix + num.toFixed(2) + '%';
                };
                
                // Update summary cards
                document.getElementById('totalValue').textContent = formatCurrency(summary.totalValue);
                
                // Daily P&L
                document.getElementById('dailyPnL').textContent = formatCurrency(summary.dailyPnL);
                document.getElementById('dailyPnL').className = 
                    `text-2xl font-bold ${summary.dailyPnL >= 0 ? 'status-green' : 'status-red'}`;
                
                // Total P&L
                document.getElementById('totalPnL').textContent = formatCurrency(summary.totalPnL || 0);
                document.getElementById('totalPnL').className = 
                    `text-2xl font-bold ${(summary.totalPnL || 0) >= 0 ? 'status-green' : 'status-red'}`;
                
                // Total Return %
                const totalReturn = this.data.portfolio?.totalPnLPercent || 0;
                document.getElementById('totalPnLPercent').textContent = formatPercent(totalReturn);
                document.getElementById('totalPnLPercent').className = 
                    `text-2xl font-bold ${totalReturn >= 0 ? 'status-green' : 'status-red'}`;

                // Update sections
                this.renderViglDiscoveries();
                this.renderPortfolioPositions();
                this.renderRecentAlerts();
                this.renderPortfolioHealth();
                
                // Update timestamp
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date(this.data.lastUpdated).toLocaleTimeString()}`;
            }

            renderViglDiscoveries() {
                const container = document.getElementById('viglDiscoveries');
                const discoveries = this.data.viglDiscoveries || [];
                
                // Apply filters
                const filters = this.getViglFilters();
                const filteredDiscoveries = discoveries.filter(stock => {
                    if (!filters.actions.includes(stock.action)) return false;
                    if (stock.score < filters.minScore) return false;
                    return true;
                });
                
                if (filteredDiscoveries.length === 0) {
                    if (discoveries.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-blue-200 py-8">
                                <div class="text-4xl mb-3">üîç</div>
                                <h3 class="text-lg font-bold mb-2">No VIGL Patterns Found</h3>
                                <p class="text-sm mb-4">Click "Scan Market" to find moonshot opportunities</p>
                                <div class="bg-blue-900 bg-opacity-30 rounded-lg p-3 text-xs text-blue-300">
                                    üéØ Looking for 20.9x volume spikes like VIGL's 324% winner
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="text-center text-blue-200 py-8">
                                <div class="text-4xl mb-3">üîç</div>
                                <h3 class="text-lg font-bold mb-2">No Results Match Current Filters</h3>
                                <p class="text-sm">Adjust filters to see more discoveries</p>
                            </div>
                        `;
                    }
                    return;
                }
                
                container.innerHTML = filteredDiscoveries.map(stock => `
                    <div class="vigl-discovery-card bg-white bg-opacity-10 rounded-lg p-4 border-l-4 ${
                        stock.action === 'BUY' ? 'border-green-400' : 
                        stock.action === 'WATCHLIST' ? 'border-yellow-400' : 'border-blue-400'
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-bold text-lg">${stock.symbol}</span>
                                    <span class="text-xs px-2 py-1 rounded ${
                                        stock.action === 'BUY' ? 'action-buy' : 
                                        stock.action === 'WATCHLIST' ? 'action-watchlist' : 'action-monitor'
                                    }">${stock.action}</span>
                                    <span class="text-sm font-bold ${
                                        stock.score >= 80 ? 'text-green-400' : 
                                        stock.score >= 70 ? 'text-yellow-400' : 'text-orange-400'
                                    }">${stock.score}%</span>
                                    ${stock.explosivenessScore ? `
                                        <span class="text-xs px-2 py-1 rounded ${
                                            stock.explosivenessScore >= 70 ? 'bg-red-600 text-red-100' :
                                            stock.explosivenessScore >= 50 ? 'bg-orange-600 text-orange-100' :
                                            stock.explosivenessScore >= 30 ? 'bg-yellow-600 text-yellow-100' :
                                            'bg-gray-600 text-gray-100'
                                        }" title="Explosiveness Score: Technical + Short Interest + Options Flow">
                                            üí• ${stock.explosivenessScore}
                                        </span>
                                    ` : ''}
                                    ${stock.isHighConfidence ? `
                                        <span class="text-xs bg-purple-600 px-2 py-1 rounded" title="High Confidence VIGL Pattern">
                                            ‚≠ê VIGL
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="text-sm text-blue-200 mb-2">${stock.name}</div>
                                <div class="grid grid-cols-2 gap-3 text-sm mb-2">
                                    <div>Price: <span class="text-white">$${stock.currentPrice.toFixed(2)}</span></div>
                                    <div>Volume: <span class="text-yellow-400">${stock.volumeSpike.toFixed(1)}x</span></div>
                                    <div>Upside: <span class="text-green-400">${stock.estimatedUpside}</span></div>
                                    <div>Timeline: <span class="text-blue-400">${stock.timeline}</span></div>
                                    ${stock.targetPrices ? `
                                        <div>Target: <span class="text-yellow-300">$${stock.targetPrices.moderate.toFixed(2)}</span></div>
                                        <div>Risk: <span class="text-orange-400">${stock.riskLevel}</span></div>
                                    ` : ''}
                                </div>
                                ${stock.catalysts && stock.catalysts.length > 0 ? `
                                    <div class="text-xs text-blue-300 bg-black bg-opacity-20 rounded px-2 py-1">
                                        üìã ${stock.catalysts.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-sm font-bold mb-2 ${
                                    stock.positionSize === 'LARGE' ? 'text-green-400' : 
                                    stock.positionSize === 'MEDIUM' ? 'text-yellow-400' : 'text-blue-400'
                                }">${stock.positionSize}</div>
                                ${stock.action === 'BUY' ? `
                                    <button onclick="showTradeModal('buy', '${stock.symbol}', ${stock.recommendedQuantity || 10})" 
                                            class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs font-medium transition-colors mb-1 block w-full">
                                        üí∞ BUY ${stock.recommendedQuantity || 10}
                                    </button>
                                    <div class="text-xs text-green-300 mb-1">~$${((stock.recommendedQuantity || 10) * stock.currentPrice).toFixed(0)}</div>
                                    <button onclick="window.dashboard.addToWatchlist('${stock.symbol}')" 
                                            class="bg-gray-600 hover:bg-gray-700 px-2 py-1 rounded text-xs transition-colors block w-full">
                                        üëÅÔ∏è Watch
                                    </button>
                                ` : stock.action === 'WATCHLIST' ? `
                                    <button onclick="window.dashboard.addToWatchlist('${stock.symbol}')" 
                                            class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded text-xs transition-colors mb-1 block w-full">
                                        üëÅÔ∏è Watch
                                    </button>
                                    <button onclick="showTradeModal('buy', '${stock.symbol}', ${Math.floor(500 / stock.currentPrice)})" 
                                            class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs transition-colors block w-full">
                                        üí∞ Buy
                                    </button>
                                ` : `
                                    <button onclick="window.dashboard.addToMonitor('${stock.symbol}')" 
                                            class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs transition-colors mb-1 block w-full">
                                        üìä Monitor
                                    </button>
                                    <button onclick="showTradeModal('buy', '${stock.symbol}', ${Math.floor(250 / stock.currentPrice)})" 
                                            class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs transition-colors block w-full">
                                        üí∞ Buy
                                    </button>
                                `}
                            </div>
                        </div>
                        <div class="vigl-score-bar mt-2" style="width: ${Math.max(stock.score, stock.explosivenessScore || 0)}%"></div>
                    </div>
                `).join('');
            }

            getViglFilters() {
                const actions = [];
                if (document.getElementById('viglFilterBuy')?.checked) actions.push('BUY');
                if (document.getElementById('viglFilterWatchlist')?.checked) actions.push('WATCHLIST');
                if (document.getElementById('viglFilterMonitor')?.checked) actions.push('MONITOR');
                
                const minScore = parseInt(document.getElementById('viglMinScoreSlider')?.value || 0);
                
                return { actions, minScore };
            }

            renderPortfolioPositions() {
                const container = document.getElementById('portfolioPositions');
                const positions = this.data.portfolio?.positions || [];
                
                if (positions.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-8">No positions found...</div>';
                    return;
                }
                
                container.innerHTML = positions.map(pos => {
                    // Use thesis data if available, fallback to old calculation
                    const thesis = pos.thesis;
                    let priceTarget, timeline, compactThesis, upside;
                    
                    if (thesis) {
                        // Use actual thesis data
                        priceTarget = thesis.targetPrices?.moderate?.toFixed(2) || (pos.currentPrice * 1.1).toFixed(2);
                        timeline = thesis.timeline || '3-6mo';
                        compactThesis = thesis.thesis || thesis.reasoning || 'Monitor position';
                        upside = thesis.targetPrices?.upside?.primary || 
                                ((priceTarget - pos.currentPrice) / pos.currentPrice * 100);
                    } else {
                        // Fallback calculations
                        if (pos.riskAnalysis?.recommendation === 'BUY_MORE') {
                            priceTarget = (pos.currentPrice * 1.4).toFixed(2);
                            timeline = '2-6mo';
                            compactThesis = `Low risk + profitable - Add to winner`;
                        } else if (pos.riskAnalysis?.recommendation === 'SELL') {
                            priceTarget = (pos.currentPrice * 0.75).toFixed(2);
                            timeline = 'Exit Now';
                            compactThesis = `High risk (${Math.round(pos.riskAnalysis.wolfScore * 100)}%) - Exit to preserve capital`;
                        } else {
                            priceTarget = (pos.currentPrice * 1.1).toFixed(2);
                            timeline = '1-3mo';
                            compactThesis = `Risk acceptable - Monitor position`;
                        }
                        upside = ((priceTarget - pos.currentPrice) / pos.currentPrice * 100);
                    }
                    
                    // Action button
                    let actionButton = '';
                    if (pos.riskAnalysis?.recommendation === 'SELL') {
                        actionButton = `<button onclick="showTradeModal('sell', '${pos.symbol}', ${Math.min(pos.qty, 10)})" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">üîª Sell</button>`;
                    } else if (pos.riskAnalysis?.recommendation === 'BUY_MORE') {
                        actionButton = `<button onclick="showTradeModal('buy', '${pos.symbol}', 10)" class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs">üìà Add</button>`;
                    } else if (pos.riskAnalysis?.recommendation === 'REDUCE') {
                        actionButton = `<button onclick="showTradeModal('sell', '${pos.symbol}', ${Math.floor(pos.qty / 2)})" class="bg-orange-600 hover:bg-orange-700 px-2 py-1 rounded text-xs">‚öñÔ∏è Reduce</button>`;
                    } else {
                        actionButton = `
                            <button onclick="showTradeModal('sell', '${pos.symbol}', 5)" class="bg-gray-600 hover:bg-gray-700 px-2 py-1 rounded text-xs mr-1">Sell</button>
                            <button onclick="showTradeModal('buy', '${pos.symbol}', 5)" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">Buy</button>`;
                    }
                    
                    return `
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 border-l-4 ${
                        pos.riskAnalysis?.wolfScore >= 0.6 ? 'border-red-400' : 
                        pos.riskAnalysis?.wolfScore >= 0.4 ? 'border-yellow-400' : 'border-green-400'
                    }">
                        <!-- Header Row -->
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg">${pos.symbol}</span>
                                <span class="text-xs ${pos.unrealizedPnL >= 0 ? 'status-green' : 'status-red'}">
                                    ${pos.unrealizedPnLPercent >= 0 ? '+' : ''}${pos.unrealizedPnLPercent.toFixed(1)}%
                                </span>
                                <span class="text-xs ${(pos.dailyPnLPercent || 0) >= 0 ? 'text-green-300' : 'text-red-300'}">
                                    ${pos.dailyPnLPercent === 0 || !pos.dailyPnLPercent ? '(--% today)' : 
                                      `(${(pos.dailyPnLPercent || 0) >= 0 ? '+' : ''}${(pos.dailyPnLPercent || 0).toFixed(1)}% today)`}
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-sm font-bold ${
                                    pos.riskAnalysis?.recommendation === 'SELL' ? 'status-red' : 
                                    pos.riskAnalysis?.recommendation === 'BUY_MORE' ? 'status-green' : 
                                    pos.riskAnalysis?.recommendation === 'REDUCE' ? 'status-yellow' : 'text-white'
                                }" ${pos.riskAnalysis?.reason ? `title="${pos.riskAnalysis.reason.replace(/"/g, '&quot;')}"` : ''}>${pos.riskAnalysis?.recommendation || 'HOLD'}</div>
                                ${actionButton}
                            </div>
                        </div>
                        
                        <!-- Data Row -->
                        <div class="grid grid-cols-6 gap-2 text-xs text-blue-200 mb-2">
                            <div>Qty: <span class="text-white">${pos.qty}</span></div>
                            <div>Entry: <span class="text-white">$${pos.avgEntryPrice.toFixed(2)}</span></div>
                            <div>Current: <span class="text-white">$${pos.currentPrice.toFixed(2)}</span></div>
                            <div>Target: <span class="text-yellow-400">$${priceTarget}</span></div>
                            <div>Upside: <span class="${upside > 0 ? 'text-green-400' : upside < 0 ? 'text-red-400' : 'text-gray-400'}">
                                ${isNaN(upside) ? '--' : `${upside > 0 ? '+' : ''}${upside.toFixed(0)}%`}
                            </span></div>
                            <div>Risk: <span class="text-white">${Math.round((pos.riskAnalysis?.wolfScore || 0) * 100)}%</span></div>
                        </div>
                        
                        <!-- Compact Thesis -->
                        <div class="text-xs text-blue-100 bg-black bg-opacity-20 rounded px-2 py-1">
                            <span class="text-blue-300">üìã</span> ${compactThesis}
                        </div>
                    </div>`;
                }).join('');
            }

            renderRecentAlerts() {
                const container = document.getElementById('recentAlerts');
                const alerts = this.data.alerts || [];
                
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-4">No alerts yet...</div>';
                    return;
                }
                
                container.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 border-l-4 ${
                        alert.severity === 'HIGH' ? 'border-red-400' : 'border-yellow-400'
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold text-sm">${alert.title}</div>
                                <div class="text-xs text-blue-200 mt-1">${alert.message}</div>
                            </div>
                            <div class="text-xs text-blue-300">
                                ${new Date(alert.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const status = document.getElementById('connectionStatus');
                
                if (connected) {
                    dot.className = 'w-3 h-3 rounded-full mr-2 pulse-dot status-green';
                    status.textContent = 'Alpaca Connected';
                } else {
                    dot.className = 'w-3 h-3 rounded-full mr-2 pulse-dot status-yellow';
                    status.textContent = 'Mock Data Mode';
                }
            }

            showLoading(show) {
                document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            }

            showSuccess(message) {
                // Simple success notification (could be enhanced with toast library)
                console.log('Success:', message);
            }

            showError(message) {
                console.error('Error:', message);
                // Could show toast notification here
            }

            startAutoRefresh() {
                // Auto-refresh every 60 seconds
                this.refreshInterval = setInterval(() => {
                    this.loadDashboard();
                }, 60000);
            }

            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }

            async executeTrade(action, symbol, qty) {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/trade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, symbol, qty })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showSuccess(`${result.message} - Order ID: ${result.orderId}`);
                        // Refresh dashboard to show updated positions
                        setTimeout(() => this.loadDashboard(), 2000);
                    } else {
                        this.showError(result.error || 'Trade failed');
                    }
                    
                } catch (error) {
                    console.error('Trade execution error:', error);
                    this.showError('Failed to execute trade');
                } finally {
                    this.showLoading(false);
                }
            }

            // Market Intelligence Methods
            async loadMarketIntelligence() {
                try {
                    const response = await fetch('/api/market-intelligence');
                    if (!response.ok) throw new Error('Failed to load market intelligence');
                    
                    const data = await response.json();
                    this.updateIntelligenceUI(data);
                } catch (error) {
                    console.error('Market intelligence load error:', error);
                }
            }

            async toggleIntelligenceMonitoring() {
                const btn = document.getElementById('toggleIntelligenceBtn');
                const status = document.getElementById('intelligenceStatus');
                const isMonitoring = status.textContent.trim() === 'Active';
                
                try {
                    this.showLoading(true);
                    
                    const endpoint = isMonitoring ? '/api/market-intelligence/stop' : '/api/market-intelligence/start';
                    const response = await fetch(endpoint, { method: 'POST' });
                    
                    if (!response.ok) throw new Error('Failed to toggle monitoring');
                    
                    const result = await response.json();
                    
                    if (isMonitoring) {
                        status.textContent = 'Inactive';
                        status.className = 'text-xs px-2 py-1 rounded bg-gray-700 text-gray-300';
                        btn.textContent = 'Start Monitoring';
                        this.showSuccess('Market intelligence monitoring stopped');
                    } else {
                        status.textContent = 'Active';
                        status.className = 'text-xs px-2 py-1 rounded bg-green-700 text-green-300';
                        btn.textContent = 'Stop Monitoring';
                        this.showSuccess('Market intelligence monitoring started');
                        
                        // Start polling for updates
                        this.startIntelligencePolling();
                    }
                    
                } catch (error) {
                    console.error('Toggle monitoring error:', error);
                    this.showError('Failed to toggle monitoring');
                } finally {
                    this.showLoading(false);
                }
            }

            startIntelligencePolling() {
                // Poll every 30 seconds for new discoveries
                if (this.intelligenceInterval) {
                    clearInterval(this.intelligenceInterval);
                }
                
                this.intelligenceInterval = setInterval(() => {
                    this.loadMarketIntelligence();
                }, 30000);
                
                // Load immediately
                this.loadMarketIntelligence();
            }

            updateIntelligenceUI(data) {
                // Update stats
                document.getElementById('totalDiscoveries').textContent = data.discoveries?.length || 0;
                document.getElementById('totalConfluences').textContent = data.confluences?.length || 0;
                
                // Update status if monitoring
                if (data.isMonitoring) {
                    const status = document.getElementById('intelligenceStatus');
                    status.textContent = 'Active';
                    status.className = 'text-xs px-2 py-1 rounded bg-green-700 text-green-300';
                    document.getElementById('toggleIntelligenceBtn').textContent = 'Stop Monitoring';
                }
                
                // Render discoveries
                const container = document.getElementById('intelligenceDiscoveries');
                
                if (!data.discoveries || data.discoveries.length === 0) {
                    if (data.isMonitoring) {
                        container.innerHTML = `
                            <div class="text-center text-blue-200 py-8">
                                <div class="animate-pulse">üîç Monitoring active...</div>
                                <div class="text-sm mt-2">Scanning Reddit, YouTube, FDA, and SEC</div>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Render discovery cards
                container.innerHTML = data.discoveries.map(discovery => {
                    const sourceIcon = {
                        reddit: 'üí¨',
                        youtube: 'üì∫',
                        fda: 'üíä',
                        sec: 'üìÑ'
                    }[discovery.source] || 'üîç';
                    
                    const confidenceColor = discovery.confidence > 0.8 ? 'text-green-400' : 
                                           discovery.confidence > 0.6 ? 'text-yellow-400' : 'text-blue-400';
                    
                    return `
                        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3 hover:bg-opacity-70 transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center">
                                    <span class="text-lg mr-2">${sourceIcon}</span>
                                    <span class="font-bold text-lg">${discovery.symbol}</span>
                                    <span class="text-xs ml-2 px-2 py-1 rounded bg-gray-700">${discovery.source}</span>
                                </div>
                                <span class="${confidenceColor} text-sm font-bold">
                                    ${(discovery.confidence * 100).toFixed(0)}%
                                </span>
                            </div>
                            
                            <div class="text-sm text-blue-200 mb-2">
                                ${discovery.type.replace(/_/g, ' ')}
                                ${discovery.data?.sentimentLabel ? `‚Ä¢ ${discovery.data.sentimentLabel}` : ''}
                            </div>
                            
                            ${discovery.data?.mentionCount ? `
                                <div class="text-xs text-gray-400">
                                    ${discovery.data.mentionCount} mentions
                                    ${discovery.data.mentionMultiple ? `(${discovery.data.mentionMultiple.toFixed(1)}x normal)` : ''}
                                </div>
                            ` : ''}
                            
                            ${discovery.catalystDate ? `
                                <div class="text-xs text-yellow-400 mt-1">
                                    üìÖ Catalyst: ${new Date(discovery.catalystDate).toLocaleDateString()}
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">
                                    ${new Date(discovery.timestamp).toLocaleTimeString()}
                                </span>
                                <button onclick="showTradeModal('buy', '${discovery.symbol}', 10)" 
                                        class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">
                                    Trade
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add confluences if any
                if (data.confluences && data.confluences.length > 0) {
                    const confluenceHTML = data.confluences.map(conf => `
                        <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-3 mb-3">
                            <div class="flex items-center mb-2">
                                <span class="text-xl mr-2">üéØ</span>
                                <span class="font-bold text-lg">${conf.symbol}</span>
                                <span class="ml-2 text-xs px-2 py-1 rounded bg-yellow-700 text-yellow-200">
                                    CONFLUENCE
                                </span>
                            </div>
                            <div class="text-sm text-yellow-200">
                                ${conf.sources.join(', ')} signals converged
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                Confidence: ${(conf.averageConfidence * 100).toFixed(0)}%
                            </div>
                        </div>
                    `).join('');
                    
                    container.innerHTML = confluenceHTML + container.innerHTML;
                }
            }

            renderPortfolioHealth() {
                const health = this.data.health;
                if (!health || !health.summary) return;

                // Update health score and status
                document.getElementById('healthScore').textContent = `${health.summary.health}/100`;
                document.getElementById('healthScore').className = `text-sm font-bold px-3 py-1 rounded ${
                    health.summary.health >= 80 ? 'bg-green-700 text-green-200' :
                    health.summary.health >= 60 ? 'bg-yellow-700 text-yellow-200' :
                    'bg-red-700 text-red-200'
                }`;
                
                document.getElementById('healthStatus').textContent = health.summary.status.emoji;

                // Update metrics
                if (health.metrics) {
                    document.getElementById('winRate').textContent = `${health.metrics.winRate.toFixed(0)}%`;
                    document.getElementById('winRate').className = `text-xl font-bold ${
                        health.metrics.winRate >= 60 ? 'text-green-400' : 
                        health.metrics.winRate >= 40 ? 'text-yellow-400' : 'text-red-400'
                    }`;

                    document.getElementById('bestPerformer').textContent = 
                        `${health.metrics.bestPerformer.symbol} +${health.metrics.bestPerformer.return.toFixed(0)}%`;

                    document.getElementById('volatility').textContent = `${health.metrics.volatility.toFixed(1)}%`;
                }

                // Update risk level
                if (health.riskProfile) {
                    document.getElementById('riskLevel').textContent = health.riskProfile.level;
                    document.getElementById('riskLevel').className = `text-xl font-bold ${
                        health.riskProfile.level === 'LOW' ? 'text-green-400' :
                        health.riskProfile.level === 'MODERATE' ? 'text-yellow-400' : 'text-red-400'
                    }`;
                }

                // Update outlook
                if (health.outlook) {
                    document.getElementById('outlookSummary').textContent = health.outlook.summary;
                    
                    document.getElementById('outlookSentiment').textContent = health.outlook.sentiment;
                    document.getElementById('outlookSentiment').className = `ml-2 text-sm px-2 py-1 rounded ${
                        health.outlook.sentiment === 'BULLISH' ? 'bg-green-700 text-green-200' :
                        health.outlook.sentiment === 'BEARISH' ? 'bg-red-700 text-red-200' :
                        'bg-gray-700 text-gray-200'
                    }`;
                    
                    document.getElementById('keyFocus').textContent = health.outlook.keyFocus.join(', ');
                    document.getElementById('timeframe').textContent = health.outlook.timeframe;
                }

                // Update recommendations
                this.renderRecommendations(health.recommendations || []);
                this.renderOpportunities(health.opportunities || []);
            }

            renderRecommendations(recommendations) {
                const container = document.getElementById('recommendations');
                
                if (recommendations.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-4">No specific recommendations at this time</div>';
                    return;
                }

                container.innerHTML = recommendations.map(rec => `
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3 border-l-4 ${
                        rec.priority === 'HIGH' ? 'border-red-400' : 
                        rec.priority === 'MEDIUM' ? 'border-yellow-400' : 'border-blue-400'
                    }">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-sm">${rec.action.replace(/_/g, ' ')}</span>
                            <span class="text-xs px-2 py-1 rounded ${
                                rec.priority === 'HIGH' ? 'bg-red-600 text-red-200' :
                                rec.priority === 'MEDIUM' ? 'bg-yellow-600 text-yellow-200' :
                                'bg-blue-600 text-blue-200'
                            }">${rec.priority}</span>
                        </div>
                        <div class="text-sm text-blue-200">${rec.description}</div>
                        ${rec.targets && rec.targets.length > 0 ? `
                            <div class="text-xs text-blue-300 mt-1">
                                Targets: ${rec.targets.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            renderOpportunities(opportunities) {
                const container = document.getElementById('opportunities');
                
                if (opportunities.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-4">No opportunities identified</div>';
                    return;
                }

                container.innerHTML = opportunities.map(opp => `
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-3 hover:bg-opacity-70 transition-all">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold">${opp.symbol}</span>
                                <span class="text-xs px-2 py-1 rounded ${
                                    opp.type === 'ADD' ? 'bg-green-700 text-green-200' :
                                    opp.type === 'REDUCE' ? 'bg-red-700 text-red-200' :
                                    'bg-blue-700 text-blue-200'
                                }">${opp.type}</span>
                            </div>
                            <div class="text-sm font-bold">${(opp.confidence * 100).toFixed(0)}%</div>
                        </div>
                        <div class="text-sm text-blue-200">${opp.reason}</div>
                        <div class="mt-2">
                            <button onclick="showTradeModal('${opp.type.toLowerCase().includes('add') ? 'buy' : 'sell'}', '${opp.symbol}', 10)" 
                                    class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">
                                Action
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Trade Modal Functions
        let currentTradeData = {};

        function showTradeModal(action, symbol, defaultQty) {
            // Find the position data to get current price
            const position = window.dashboard?.data?.portfolio?.positions?.find(p => p.symbol === symbol);
            const discovery = window.dashboard?.data?.discoveries?.find(d => d.symbol === symbol);
            const currentPrice = position?.currentPrice || discovery?.currentPrice || 0;
            
            currentTradeData = {
                action: action.toLowerCase(),
                symbol: symbol,
                price: currentPrice
            };
            
            // Set default dollar amount (defaultQty * price, or $1000)
            const defaultDollarAmount = defaultQty && currentPrice ? (defaultQty * currentPrice) : 1000;
            document.getElementById('tradeDollarAmount').value = Math.round(defaultDollarAmount);
            
            // Calculate trading recommendations
            const entryTarget = action.toLowerCase() === 'buy' ? currentPrice * 0.98 : currentPrice; // 2% below for entries
            const stopLoss = action.toLowerCase() === 'buy' ? currentPrice * 0.85 : currentPrice * 1.15; // 15% risk
            let priceTarget, timeline;
            
            if (discovery) {
                // Use VIGL discovery data for targets
                if (discovery.estimatedUpside === '200-400%') {
                    priceTarget = currentPrice * 3.0; // 200% conservative
                    timeline = '3-6 months';
                } else if (discovery.estimatedUpside === '100-200%') {
                    priceTarget = currentPrice * 1.5; // 50% conservative  
                    timeline = '2-4 months';
                } else {
                    priceTarget = currentPrice * 1.25; // 25% conservative
                    timeline = '1-3 months';
                }
            } else if (position) {
                // Use position analysis for targets
                if (position.riskAnalysis?.recommendation === 'BUY_MORE') {
                    priceTarget = currentPrice * 1.4;
                    timeline = '2-6 months';
                } else {
                    priceTarget = currentPrice * 1.1;
                    timeline = '1-2 months';
                }
            }
            
            // Update modal content
            document.getElementById('modalTitle').textContent = `${action.toUpperCase()} ${symbol}`;
            document.getElementById('modalAction').textContent = action.toUpperCase();
            document.getElementById('modalAction').className = `text-lg font-bold ${action.toLowerCase() === 'sell' ? 'text-red-400' : 'text-green-400'}`;
            document.getElementById('modalSymbol').textContent = symbol;
            document.getElementById('modalPrice').textContent = `$${currentPrice.toFixed(2)}`;
            document.getElementById('entryTarget').textContent = `$${entryTarget.toFixed(2)}`;
            document.getElementById('stopLoss').textContent = `$${stopLoss.toFixed(2)}`;
            document.getElementById('priceTarget').textContent = `$${priceTarget.toFixed(2)}`;
            document.getElementById('timeline').textContent = timeline;
            document.getElementById('tradeQuantity').value = defaultQty;
            document.getElementById('executeBtn').className = `flex-1 py-2 rounded font-medium transition-colors ${action.toLowerCase() === 'sell' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`;
            document.getElementById('executeBtn').textContent = `${action.toUpperCase()} ${symbol}`;
            
            // Update estimated cost and shares
            updateTradeCalculations();
            
            // Show modal
            document.getElementById('tradeModal').classList.remove('hidden');
            
            // Add dollar amount change listener
            document.getElementById('tradeDollarAmount').addEventListener('input', updateTradeCalculations);
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.add('hidden');
            currentTradeData = {};
        }

        function updateTradeCalculations() {
            const dollarAmount = parseFloat(document.getElementById('tradeDollarAmount').value) || 0;
            const price = currentTradeData.price || 1;
            
            // Calculate shares from dollar amount
            const shares = Math.floor(dollarAmount / price);
            document.getElementById('tradeQuantity').value = shares;
            
            // Update estimated cost (which is just the dollar amount entered)
            document.getElementById('estimatedCost').textContent = dollarAmount.toLocaleString();
        }
        
        function updateEstimatedCost() {
            updateTradeCalculations();
        }

        async function executeTrade() {
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (window.dashboard) {
                closeTradeModal();
                await window.dashboard.executeTrade(currentTradeData.action, currentTradeData.symbol, quantity);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new TradingDashboard();
            
            // Add market intelligence button listener
            document.getElementById('toggleIntelligenceBtn').addEventListener('click', () => {
                window.dashboard.toggleIntelligenceMonitoring();
            });
            
            // Load market intelligence status on startup
            window.dashboard.loadMarketIntelligence();
            // Check VIGL health on startup
            window.dashboard.checkViglHealth().then(health => {
                if (!health.healthy) {
                    console.warn('‚ö†Ô∏è VIGL system not fully operational');
                }
            });
        });

        // Add VIGL-specific methods to TradingDashboard
        TradingDashboard.prototype.executeViglBuy = async function(symbol, quantity) {
            try {
                this.showLoading(true);
                
                console.log(`üìà Executing VIGL buy order: ${quantity} shares of ${symbol}`);
                
                const response = await fetch('/api/vigl-buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol,
                        quantity,
                        orderType: 'market'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess(`‚úÖ VIGL order placed: ${quantity} shares of ${symbol} (Order ID: ${result.orderId})`);
                    // Refresh portfolio after successful trade
                    setTimeout(() => this.loadDashboard(), 2000);
                } else {
                    this.showError(result.error || `Failed to buy ${symbol}`);
                }
                
            } catch (error) {
                console.error('VIGL buy error:', error);
                this.showError(`VIGL buy failed: ${error.message}`);
            } finally {
                this.showLoading(false);
            }
        };

        TradingDashboard.prototype.addToWatchlist = async function(symbol) {
            // Simple UI feedback for now - could be enhanced with backend storage
            this.showSuccess(`üìã ${symbol} added to watchlist`);
            console.log(`Watchlist: ${symbol}`);
        };

        TradingDashboard.prototype.addToMonitor = async function(symbol) {
            // Simple UI feedback for now - could be enhanced with backend storage
            this.showSuccess(`üìä ${symbol} added to monitoring`);
            console.log(`Monitor: ${symbol}`);
        };

        TradingDashboard.prototype.checkViglHealth = async function() {
            try {
                const response = await fetch('/api/vigl-health');
                const result = await response.json();
                
                if (result.healthy) {
                    console.log('‚úÖ VIGL system healthy');
                } else {
                    console.warn('‚ö†Ô∏è VIGL system issues detected');
                }
                
                return result;
            } catch (error) {
                console.error('VIGL health check failed:', error);
                return { healthy: false, error: error.message };
            }
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.dashboard) {
                window.dashboard.stopAutoRefresh();
            }
        });
    </script>
</body>
</html>