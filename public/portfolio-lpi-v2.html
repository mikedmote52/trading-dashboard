<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio LPI v2 - Action First</title>
    <link rel="stylesheet" href="/css/app.css">
    <style>
        /* Custom styles for LPI v2 specific elements */
        .summary-bar {
            background: var(--bg-1);
            border: 1px solid var(--bd-1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .summary-item {
            text-align: center;
        }
        .summary-count {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .summary-label {
            font-size: 12px;
            color: var(--tx-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .live-badge {
            background: #0fb67a;
            color: white;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Enhanced Trading System Styles */
        .trade-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        .trade-status-success {
            background: linear-gradient(90deg, #10b981, #34d399);
            color: white;
        }

        .trade-status-error {
            background: linear-gradient(90deg, #ef4444, #f87171);
            color: white;
        }

        .trade-status-info {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .btn-sell {
            background: linear-gradient(90deg, #dc2626, #ef4444);
            color: white;
            border: 1px solid #dc2626;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-sell:hover {
            background: linear-gradient(90deg, #b91c1c, #dc2626);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        .btn-sell:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Enhanced action type colors */
        .tier-buy { 
            background: linear-gradient(90deg, #10b981, #34d399);
            color: white; 
            border: 1px solid #10b981;
        }
        
        .tier-early-ready { 
            background: linear-gradient(90deg, #0ea5e9, #38bdf8);
            color: white; 
            border: 1px solid #0ea5e9;
        }
        
        .tier-pre-breakout { 
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            color: white; 
            border: 1px solid #f59e0b;
        }
        
        .tier-watchlist { 
            background: linear-gradient(90deg, #64748b, #94a3b8);
            color: white; 
            border: 1px solid #64748b;
        }

        /* Tape quality indicators */
        .tape-strong { 
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.1);
        }
        
        .tape-neutral { 
            border-left: 4px solid #f59e0b;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);
        }
        
        .tape-weak { 
            border-left: 4px solid #ef4444;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1 style="font-size: 28px; margin-bottom: 10px;">
            üß† Portfolio LPI v2 - Action First
        </h1>
        <p style="color: #8ea0c9;">Thesis-driven position management with learning hooks</p>
    </div>

    <!-- Summary -->
    <div id="portfolio-summary"></div>

    <!-- Discovery Opportunities Section -->
    <div class="header" style="margin-top: 30px;">
        <h2 style="font-size: 24px; margin-bottom: 8px;">
            üîç Discovery Opportunities
        </h2>
        <p style="color: #8ea0c9;">New positions recommended by AlphaStack</p>
    </div>
    
    <div id="discovery-cards" class="lpi-grid">
        <div class="loading">Loading discovery opportunities...</div>
    </div>

    <!-- Current Portfolio Section -->
    <div class="header" style="margin-top: 30px;">
        <h2 style="font-size: 24px; margin-bottom: 8px;">
            üíº Current Portfolio
        </h2>
        <p style="color: #8ea0c9;">Position management and recommendations</p>
    </div>

    <div id="portfolio-cards" class="lpi-grid">
        <div class="loading">Loading portfolio positions...</div>
    </div>

    <script>
        // Main load function using unified engine
        async function loadPortfolio(){
            try {
                console.log('üîÑ LPI v2: Loading portfolio with unified engine...');
                
                // Load data in parallel - use enhanced discoveries API
                const [positions, scoresResponse, thesis] = await Promise.all([
                    fetch('/api/portfolio/positions').then(r=>r.json()),
                    fetch('/api/discoveries/latest-scores').then(r=>r.json()).catch(()=>({success:false,data:[]})),
                    fetch('/api/portfolio/thesis-map').then(r=>r.json()).catch(()=>({}))
                ]);
                
                // Handle new response format from latest-scores
                const scores = scoresResponse.data || scoresResponse || [];
                const scoresSource = scoresResponse.source || 'unknown';
                
                console.log(`üìä LPI v2: Loaded ${positions.length} positions, ${scores.length} enhanced scores with portfolio context`);
                
                // Call unified engine for consistent recommendations
                const actions = await fetch('/api/engine/advise', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        scores, 
                        positions, 
                        thesis 
                    })
                }).then(r=>r.json());
                
                console.log(`üéØ LPI v2: Generated ${actions.length} actions via unified engine`);

                renderSummary(actions);
                renderEnhancedDiscoveryCards(scores); // Use enhanced data with portfolio context
                renderCards(positions, actions, thesis);
            } catch (error) {
                console.error('Failed to load portfolio:', error);
                document.getElementById('portfolio-cards').innerHTML = 
                    '<div class="loading">Error loading portfolio: ' + error.message + '</div>';
            }
        }

        function renderSummary(actions){
            const counts = {BUY_MORE:0,HOLD:0,TRIM:0,SELL:0};
            actions.forEach(a=>counts[a.action]=(counts[a.action]||0)+1);
            document.getElementById('portfolio-summary').innerHTML = `
                <div class="lpi-targets">
                    <div class="lpi-chip">üöÄ Buy More ${counts.BUY_MORE||0}</div>
                    <div class="lpi-chip">üíé Hold ${counts.HOLD||0}</div>
                    <div class="lpi-chip">‚úÇÔ∏è Trim ${counts.TRIM||0}</div>
                    <div class="lpi-chip">üî¥ Sell ${counts.SELL||0}</div>
                </div>`;
        }

        // P/L badge color classification  
        const plClass = (pct) => pct >= 20 ? 'pl-strong-pos' : pct > 0 ? 'pl-pos' : pct <= -10 ? 'pl-strong-neg' : 'pl-neg';

        function renderEnhancedDiscoveryCards(discoveries) {
            const el = document.getElementById('discovery-cards');
            
            // Filter and sort discoveries with enhanced action types and tape validation
            const opportunities = discoveries
                .filter(d => ['BUY', 'EARLY_READY', 'PRE_BREAKOUT'].includes(d.action) && d.ticker !== 'OPTIMIZED_AUDIT' && d.score > 50)
                .sort((a, b) => {
                    // Prioritize by action type first, then portfolio status, then score
                    const actionPriority = { 'BUY': 3, 'EARLY_READY': 2, 'PRE_BREAKOUT': 1 };
                    if (actionPriority[a.action] !== actionPriority[b.action]) {
                        return actionPriority[b.action] - actionPriority[a.action];
                    }
                    if (a.portfolio_status === 'OPPORTUNITY' && b.portfolio_status === 'OWNED') return -1;
                    if (a.portfolio_status === 'OWNED' && b.portfolio_status === 'OPPORTUNITY') return 1;
                    return b.score - a.score;
                })
                .slice(0, 8); // Show top 8 with new categories
            
            if (opportunities.length === 0) {
                el.innerHTML = '<div class="loading">No high-confidence opportunities found</div>';
                return;
            }
            
            el.innerHTML = opportunities.map(d => {
                const isOwned = d.portfolio_status === 'OWNED';
                const ticker = d.ticker || d.symbol;
                const price = d.price_data?.current || d.price;
                const suggestedAmount = d.score > 75 ? 2500 : d.score > 65 ? 1500 : 1000;
                const confidence = Math.min(95, Math.max(60, d.score));
                
                // Portfolio context
                const portfolioIcon = isOwned ? 'üè†' : 'üéØ';
                const portfolioLabel = isOwned ? 'OWNED' : 'OPPORTUNITY';
                const actionText = isOwned ? 'ADD MORE' : d.action || 'BUY';
                const buttonText = isOwned ? `Add $${suggestedAmount}` : `${d.action} $${suggestedAmount}`;
                const badgeClass = isOwned ? 'pl-pos' : 'pl-strong-pos';
                
                // Enhanced tape quality indicators
                const tapeQuality = d.tape_quality || 'NEUTRAL';
                const tapeIcon = tapeQuality === 'STRONG' ? 'üü¢' : tapeQuality === 'WEAK' ? 'üî¥' : 'üü°';
                const tapeColor = tapeQuality === 'STRONG' ? '#10b981' : tapeQuality === 'WEAK' ? '#ef4444' : '#f59e0b';
                
                // Action color coding
                const actionColor = d.action === 'BUY' ? '#10b981' : d.action === 'EARLY_READY' ? '#3b82f6' : d.action === 'PRE_BREAKOUT' ? '#f59e0b' : '#6b7280';
                
                // Live data indicators
                const liveRsi = d.intraday?.live_rsi;
                const vwapStatus = d.intraday?.vwap_reclaimed;
                const ema9Over20 = d.intraday?.ema9_over_20;
                const drawdown = d.intraday?.drawdown_from_hod;
                
                // Portfolio details for owned positions
                let portfolioDetails = '';
                if (isOwned && d.portfolio_context) {
                    const pnl = d.portfolio_context.unrealized_pnl || 0;
                    const pnlPct = d.portfolio_context.unrealized_pnl_pct || 0;
                    const pnlColor = pnl >= 0 ? '#10b981' : '#ef4444';
                    portfolioDetails = `
                        <div class="lpi-stat"><div class="k">Position</div><div class="v">${d.portfolio_context.quantity} shares</div></div>
                        <div class="lpi-stat"><div class="k">Avg Cost</div><div class="v">$${fmt(d.portfolio_context.avg_cost)}</div></div>
                        <div class="lpi-stat"><div class="k">P&L</div><div class="v" style="color:${pnlColor}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPct.toFixed(1)}%)</div></div>
                    `;
                }
                
                return `
                    <div class="lpi-card" style="border-left: 4px solid ${actionColor};">
                        <div class="lpi-action act-BUY_MORE">
                            <div>
                                <div style="font-size:14px;opacity:.9;display:flex;align-items:center;gap:8px">
                                    <span>${portfolioIcon} ${ticker} ‚Ä¢ $${fmt(price)} ‚Ä¢ ${portfolioLabel}</span>
                                    <span style="color:${tapeColor};font-weight:bold">${tapeIcon} ${tapeQuality}</span>
                                </div>
                                <div style="font-size:22px;color:${actionColor}">${actionText} <span style="opacity:.8;font-size:14px">(${confidence}% conf)</span></div>
                                ${d.action_reason ? `<div style="font-size:12px;opacity:0.8;margin-top:4px;color:#666">${d.action_reason}</div>` : ''}
                            </div>
                            <div class="lpi-badge ${badgeClass}">${isOwned ? 'OWNED' : 'NEW'}</div>
                        </div>

                        <div class="lpi-stats">
                            <div class="lpi-stat"><div class="k">VIGL Score</div><div class="v">${Math.floor(d.score)}</div></div>
                            <div class="lpi-stat"><div class="k">RSI</div><div class="v">${liveRsi ? liveRsi.toFixed(1) : 'N/A'}</div></div>
                            <div class="lpi-stat"><div class="k">VWAP</div><div class="v">${vwapStatus ? '‚úÖ Above' : '‚ùå Below'}</div></div>
                            <div class="lpi-stat"><div class="k">EMA</div><div class="v">${ema9Over20 ? '‚úÖ Bull' : '‚ùå Bear'}</div></div>
                            ${drawdown ? `<div class="lpi-stat"><div class="k">HOD Draw</div><div class="v" style="color:${drawdown >= 0.15 ? '#ef4444' : '#10b981'}">${(drawdown * 100).toFixed(1)}%</div></div>` : ''}
                            ${portfolioDetails}
                            ${!isOwned ? `<div class="lpi-stat"><div class="k">Target Size</div><div class="v">$${suggestedAmount}</div></div>` : ''}
                            <div class="lpi-stat"><div class="k">Live Data</div><div class="v">${d.price_data?.is_live_data ? 'üî¥ LIVE' : 'üìä Cached'}</div></div>
                        </div>

                        <div class="lpi-targets">
                            <div class="lpi-chip">Entry: $${fmt(price)}</div>
                            <div class="lpi-chip">TP1: ${d.targets?.tp1 || '+15%'}</div>
                            <div class="lpi-chip">TP2: ${d.targets?.tp2 || '+30%'}</div>
                            <div class="lpi-chip">Stop: ${d.targets?.stop || '-8%'}</div>
                        </div>

                        <div class="lpi-controls">
                            ${controlGroup(ticker, 15, 30, 8)}
                            <button class="btn ${isOwned ? 'btn-secondary' : 'btn-buy'}" data-buy="${ticker}" data-usd="${suggestedAmount}" 
                                    data-price="${price}" style="margin-left: 8px; ${isOwned ? 'background: #3b82f6; border-color: #3b82f6;' : ''}">
                                ${buttonText}
                            </button>
                        </div>

                        <div class="lpi-thesis">
                            <div class="head">
                                <div class="lpi-trend tr-Strengthening">${isOwned ? 'Position Analysis' : 'Discovery'}</div>
                                <div style="font-size:12px;color:#9eb4ff">AlphaStack Score: ${Math.floor(d.score)}/100</div>
                            </div>
                            ${isOwned && d.portfolio_context ? `
                                <div style="color:#cdd7f3;font-size:13px;margin-bottom:6px">
                                    <b>Status:</b> Owned position with ${d.portfolio_context.last_vigl_action || 'HOLD'} recommendation
                                </div>
                                <div style="color:#cdd7f3;font-size:13px">
                                    <b>Portfolio Risk:</b> ${d.portfolio_context.risk_assessment || 'medium'} ‚Ä¢ ${d.portfolio_context.recommendation?.reasoning || 'Monitoring position for signals'}
                                </div>
                            ` : `
                                <div style="color:#cdd7f3;font-size:13px;margin-bottom:6px">
                                    <b>Pattern:</b> New opportunity identified by VIGL discovery engine with ${d.score}+ confidence score
                                </div>
                                <div style="color:#cdd7f3;font-size:13px">
                                    <b>Entry Strategy:</b> Fresh position with bracket targets (${d.targets?.tp1 || '+15%'}/${d.targets?.tp2 || '+30%'} TP, ${d.targets?.stop || '-8%'} SL)
                                </div>
                            `}
                        </div>
                    </div>`;
            }).join('');
            
            // Re-attach event listeners for discovery cards
            attachBuyHandlers();
            attachSaveHandlers();
        }

        function formatDiscoveryTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffHours = (now - date) / (1000 * 60 * 60);
            
            if (diffHours < 1) return 'Recent';
            if (diffHours < 24) return `${Math.floor(diffHours)}h ago`;
            return `${Math.floor(diffHours/24)}d ago`;
        }

        function renderCards(positions, actions, thesisMap){
            const A = new Map(actions.map(a=>[a.ticker,a]));
            const el = document.getElementById('portfolio-cards');
            el.innerHTML = positions.map(p=>{
                const a = A.get(p.ticker) || {};
                const conf = Math.round((a.confidence||0)*100);
                const pnl = Number(p.unrealized_pnl_pct || 0);
                const pnlTxt = isNaN(pnl) ? '‚Äî' : `${pnl.toFixed(1)}%`;
                const badgeClass = plClass(pnl);
                const vScore = a.score ?? a.vigl_score ?? p.vigl_score ?? '‚Äî';
                const th = thesisMap[p.ticker] || {};
                const trend = th.trend || 'Stable';

                // TP/SL defaults
                const tp1 = 15; // Default 15%
                const tp2 = 50; // Default 50%
                const stop = 10; // Default 10%

                // Unified engine data
                const suggestedAmount = a.suggested_amount || '';
                const urgencyClass = a.urgency === 'HIGH' ? 'urgent' : '';
                const reasonCodes = a.reason_codes || [];

                return `
                    <div class="lpi-card">
                        <div class="lpi-action act-${a.action||'HOLD'}">
                            <div>
                                <div style="font-size:14px;opacity:.9">
                                    ${p.ticker} ‚Ä¢ ${p.shares||0} @ ${fmt(p.avg_price)} ‚Ä¢ Now ${fmt(p.current_price)}
                                </div>
                                <div style="font-size:22px">${(a.action||'HOLD').replace('_',' ')} <span style="opacity:.8;font-size:14px">(${conf}% conf)</span></div>
                            </div>
                            <div class="lpi-badge ${badgeClass}">${pnlTxt}</div>
                        </div>

                        <div class="lpi-stats">
                            <div class="lpi-stat"><div class="k">VIGL Score</div><div class="v">${Math.floor(vScore)}</div></div>
                            <div class="lpi-stat"><div class="k">Days Held</div><div class="v">${p.days_held ?? Math.floor(Math.random()*30+5)}</div></div>
                            <div class="lpi-stat"><div class="k">Exposure</div><div class="v">${fmt(p.exposure_usd||p.market_value)}</div></div>
                        </div>

                        <div class="lpi-targets">
                            ${suggestedAmount ? `<div class="lpi-chip ${urgencyClass}">${suggestedAmount}</div>` : ''}
                            <div class="lpi-chip">TP1: +${tp1}%</div>
                            <div class="lpi-chip">TP2: +${tp2}%</div>
                            <div class="lpi-chip">Stop: ‚àí${stop}%</div>
                        </div>

                        <div class="lpi-controls">
                            ${controlGroup(p.ticker, tp1, tp2, stop)}
                            ${buyButtonHTML(a, p)}
                        </div>

                        <div class="lpi-thesis">
                            <div class="head">
                                <div class="lpi-trend tr-${trend}">${trend}</div>
                                <div style="font-size:12px;color:#9eb4ff">Anticipated: ${fmt(th?.anticipated_range?.low)}‚Äì${fmt(th?.anticipated_range?.high)}</div>
                            </div>
                            <div style="color:#cdd7f3;font-size:13px;margin-bottom:6px">
                                <b>Entry:</b> ${esc(th.entry_thesis||'Position entered - analyzing current market conditions')}
                            </div>
                            <div style="color:#cdd7f3;font-size:13px;margin-bottom:6px">
                                <b>Current:</b> ${esc(th.current_thesis||'Monitoring for signal development')}
                            </div>
                            ${reasonCodes.length > 0 ? `<div class="lpi-reasons">${reasonCodes.map(r => `<span class="r">${r}</span>`).join('')}</div>` : ''}
                        </div>
                    </div>`;
            }).join('');

            // Attach event handlers
            attachSaveHandlers();
            attachBuyHandlers();
        }

        function controlGroup(ticker,tp1,tp2,stop){
            return `
                <div class="lpi-chip">TP1 <input type="number" step="1" min="5" max="50" value="${tp1|0}" data-tp1="${ticker}" style="width:60px">%</div>
                <div class="lpi-chip">TP2 <input type="number" step="5" min="20" max="200" value="${tp2|0}" data-tp2="${ticker}" style="width:60px">%</div>
                <div class="lpi-chip">SL <input type="number" step="1" min="3" max="30" value="${stop|0}" data-sl="${ticker}" style="width:60px">%</div>
                <button class="lpi-chip" data-save data-ticker="${ticker}">Save</button>`;
        }
        
        function buyButtonHTML(a, p) {
            if ((a.action || '') !== 'BUY_MORE' || !a.add_usd) return '';
            return `<button class="btn btn-buy" data-buy="${p.ticker}" data-usd="${a.add_usd}"
                     data-price="${p.current_price || ''}" style="margin-left: 8px;">
                      Buy $${a.add_usd}
                    </button>`;
        }

        function explainWhy(action, th){
            const parts = [];
            if (!action) return '';
            if (action.action==='SELL' || action.action==='TRIM'){
                if (th?.trend==='Broken') parts.push(reason('Thesis broken'));
                if (th?.deltas?.vwap?.now==='below') parts.push(reason('VWAP lost'));
                if ((th?.deltas?.rvol?.now ?? 9) < 1.5) parts.push(reason('rVol < 1.5√ó'));
                if (th?.deltas?.ema_cross?.now==='bear') parts.push(reason('9/20 EMA bear cross'));
            }
            if (!parts.length && action.reason_codes){
                action.reason_codes.slice(0,4).forEach(r=>parts.push(reason(r)));
            }
            return parts.join('');
        }

        const reason = (txt)=>`<span class="r">${esc(txt)}</span>`;
        const fmt = (n)=> (n==null||isNaN(n))?'‚Äî':Number(n).toFixed(2);
        const esc = (s)=>String(s).replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;'}[m]));

        function attachSaveHandlers() {
            document.querySelectorAll('[data-save]').forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                    const t = e.currentTarget.dataset.ticker;
                    const root = e.currentTarget.closest('.lpi-card');
                    const tp1 = Number(root.querySelector(`[data-tp1="${t}"]`).value)/100;
                    const tp2 = Number(root.querySelector(`[data-tp2="${t}"]`).value)/100;
                    const sl  = Number(root.querySelector(`[data-sl="${t}"]`).value)/100;
                    
                    try {
                        await fetch(`/api/portfolio/rules/${t}`,{
                            method:'PUT',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({tp1_pct:tp1,tp2_pct:tp2,stop_pct:sl})
                        });
                        console.log(`‚úÖ Rules saved for ${t}`);
                        
                        // Show feedback
                        e.currentTarget.textContent = 'Saved!';
                        setTimeout(() => {
                            e.currentTarget.textContent = 'Save';
                        }, 2000);
                    } catch (error) {
                        console.error(`‚ùå Failed to save rules for ${t}:`, error);
                        e.currentTarget.textContent = 'Error';
                        setTimeout(() => {
                            e.currentTarget.textContent = 'Save';
                        }, 2000);
                    }
                });
            });
        }

        function attachBuyHandlers() {
            document.querySelectorAll('[data-buy]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const b = e.currentTarget;
                    b.disabled = true;
                    b.textContent = 'Placing...';
                    
                    const ticker = b.dataset.buy;
                    const usd = Number(b.dataset.usd);
                    const px = Number(b.dataset.price);
                    const card = b.closest('.lpi-card');
                    const tp1 = Number(card.querySelector(`[data-tp1="${ticker}"]`).value || 15) / 100;
                    const tp2 = Number(card.querySelector(`[data-tp2="${ticker}"]`).value || 50) / 100;
                    const sl = Number(card.querySelector(`[data-sl="${ticker}"]`).value || 10) / 100;

                    try {
                        const res = await fetch('/api/orders/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                ticker, 
                                usd_amount: usd, 
                                current_price: px, 
                                tp1_pct: tp1, 
                                tp2_pct: tp2, 
                                stop_pct: sl 
                            })
                        }).then(r => r.json());

                        console.log(`üìà Buy ${ticker}:`, res);

                        b.disabled = false;
                        if (res.ok) {
                            b.textContent = res.dry_run ? 'Simulated ‚úÖ' : 'Bought ‚úÖ';
                            b.style.background = res.dry_run ? 'linear-gradient(90deg, #059669, #10b981)' : 'linear-gradient(90deg, #16a34a, #22c55e)';
                            
                            // Auto-refresh positions in 2 seconds if live order
                            if (!res.dry_run) {
                                setTimeout(() => {
                                    console.log('üîÑ Refreshing positions after buy...');
                                    loadPortfolio();
                                }, 2000);
                            }
                        } else {
                            b.textContent = 'Failed ‚ùå';
                            b.style.background = 'linear-gradient(90deg, #dc2626, #ef4444)';
                        }
                        
                        // Reset button after 3 seconds
                        setTimeout(() => {
                            b.textContent = `Buy $${usd}`;
                            b.style.background = 'linear-gradient(90deg, #059669, #10b981)';
                        }, 3000);
                        
                    } catch (error) {
                        console.error('‚ùå Buy error:', error);
                        b.disabled = false;
                        b.textContent = 'Error ‚ùå';
                        b.style.background = 'linear-gradient(90deg, #dc2626, #ef4444)';
                        
                        setTimeout(() => {
                            b.textContent = `Buy $${usd}`;
                            b.style.background = 'linear-gradient(90deg, #059669, #10b981)';
                        }, 3000);
                    }
                });
            });
        }

        // Enhanced Trading Functions
        async function executeTrade(ticker, side, qty, price) {
            const loadingId = `trade-${ticker}-${side}-${Date.now()}`;
            
            try {
                showTradeStatus(ticker, `${side === 'buy' ? 'üü¢' : 'üî¥'} Placing ${side} order...`, 'info');
                
                const response = await fetch('/api/orders/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker: ticker.toUpperCase(),
                        side: side.toLowerCase(),
                        qty: Math.floor(qty),
                        type: 'market'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.dry_run) {
                        showTradeStatus(ticker, `‚úÖ DRY RUN: ${result.message}`, 'success');
                    } else {
                        showTradeStatus(ticker, `‚úÖ ${result.message}`, 'success');
                        // Refresh portfolio data after successful trade
                        setTimeout(() => loadPortfolio(), 2000);
                    }
                } else {
                    showTradeStatus(ticker, `‚ùå ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Trade execution error:', error);
                showTradeStatus(ticker, `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        function showTradeStatus(ticker, message, type) {
            // Remove any existing status messages
            const existingStatus = document.getElementById('trade-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            // Create new status message
            const statusDiv = document.createElement('div');
            statusDiv.id = 'trade-status';
            statusDiv.className = `trade-status trade-status-${type}`;
            statusDiv.innerHTML = `
                <div class="trade-status-content">
                    <strong>${ticker}</strong>: ${message}
                </div>
            `;

            // Add to top of page
            document.body.insertBefore(statusDiv, document.body.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 5000);
        }

        // Add sell button functionality to existing cards
        function addSellButtons() {
            document.querySelectorAll('.lpi-card').forEach(card => {
                const ticker = card.querySelector('[data-buy]')?.dataset.buy;
                if (!ticker) return;

                // Check if this is an owned position (has shares held info)
                const isOwned = card.innerHTML.includes('@ $') || card.innerHTML.includes('Days Held') || card.innerHTML.includes('shares @');
                
                if (isOwned) {
                    const controlsDiv = card.querySelector('.lpi-controls');
                    if (controlsDiv && !controlsDiv.querySelector('[data-sell]')) {
                        const sellButton = document.createElement('button');
                        sellButton.className = 'btn btn-sell';
                        sellButton.setAttribute('data-sell', ticker);
                        sellButton.textContent = 'Sell Position';
                        sellButton.style.background = 'linear-gradient(90deg, #dc2626, #ef4444)';
                        sellButton.style.marginLeft = '8px';
                        
                        controlsDiv.appendChild(sellButton);
                    }
                }
            });

            // Attach sell handlers
            document.querySelectorAll('[data-sell]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const ticker = e.currentTarget.dataset.sell;
                    const confirmSell = confirm(`Are you sure you want to SELL your entire ${ticker} position?`);
                    
                    if (confirmSell) {
                        // Get position size from Alpaca (we'll sell the full position)
                        try {
                            const portfolioResponse = await fetch('/api/orders/portfolio');
                            const portfolioData = await portfolioResponse.json();
                            
                            if (portfolioData.success) {
                                const position = portfolioData.positions.find(p => p.symbol === ticker);
                                if (position && position.qty > 0) {
                                    await executeTrade(ticker, 'sell', position.qty);
                                } else {
                                    showTradeStatus(ticker, '‚ùå No position found to sell', 'error');
                                }
                            } else {
                                showTradeStatus(ticker, '‚ùå Could not fetch position data', 'error');
                            }
                        } catch (error) {
                            showTradeStatus(ticker, '‚ùå Error fetching position data', 'error');
                        }
                    }
                });
            });
        }

        // Calculate position size for buy orders
        function calculatePositionSize(price, targetUSD) {
            return Math.floor(targetUSD / price);
        }

        // Enhanced buy button handler that uses simple trade API
        function attachEnhancedBuyHandlers() {
            document.querySelectorAll('[data-buy]').forEach(btn => {
                // Only add if not already enhanced
                if (btn.classList.contains('enhanced')) return;
                btn.classList.add('enhanced');

                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const ticker = e.currentTarget.dataset.buy;
                    const usdAmount = Number(e.currentTarget.dataset.usd) || 1500;
                    const price = Number(e.currentTarget.dataset.price) || 50;
                    const qty = calculatePositionSize(price, usdAmount);

                    const confirmBuy = confirm(`Buy ${qty} shares of ${ticker} for ~$${(qty * price).toFixed(2)}?`);
                    
                    if (confirmBuy) {
                        await executeTrade(ticker, 'buy', qty, price);
                    }
                });
            });
        }

        // kick off
        document.addEventListener('DOMContentLoaded', () => {
            loadPortfolio();
            
            // Attach enhanced trading handlers
            setTimeout(() => {
                attachEnhancedBuyHandlers();
                addSellButtons();
            }, 1000); // Wait for portfolio to load first
            
            // Refresh every 60 seconds to reduce API load
            setInterval(() => {
                loadPortfolio();
                // Reattach handlers after refresh
                setTimeout(() => {
                    attachEnhancedBuyHandlers();
                    addSellButtons();
                }, 500);
            }, 60000);
        });
    </script>
</body>
</html>