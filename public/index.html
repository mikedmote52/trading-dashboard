<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Intelligence Dashboard</title>
    <link rel="stylesheet" href="/assets/tailwind.css">
    <script src="/js/alphastack-screener.js"></script>
    <script src="/js/enhancedPortfolio.js"></script>
    <style>
        /* Dark theme base */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }
        
        /* Card components */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        /* Portfolio styles */
        .position-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 16px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        .position-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        /* Buy button */
        .buy-button {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .buy-button:hover {
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
            transform: scale(1.05);
        }
        
        /* Loading states */
        .loading {
            opacity: 0.7;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-2">
                Trading Intelligence Dashboard
            </h1>
            <p class="text-blue-200">Portfolio Management + Universe Screening</p>
        </header>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Portfolio Management Section -->
            <div class="dashboard-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        üíº Portfolio Positions
                        <span class="ml-2 text-xs px-2 py-1 rounded bg-green-700 text-green-200">LIVE</span>
                    </h2>
                    <div class="flex space-x-3">
                        <div class="bg-slate-800 border-2 border-blue-500 rounded-xl p-1 flex shadow-lg">
                            <button id="basic-view" class="px-4 py-2 rounded-lg text-sm font-bold transition-all bg-blue-600 text-white shadow-md">
                                üìä Basic
                            </button>
                            <button id="enhanced-view" class="px-4 py-2 rounded-lg text-sm font-bold transition-all text-slate-300 hover:text-white hover:bg-slate-700">
                                ü§ñ Enhanced
                            </button>
                        </div>
                        <button id="refresh-portfolio" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl text-sm font-bold shadow-lg border border-emerald-500">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                
                <div id="portfolio-positions" class="loading">
                    Loading portfolio positions...
                </div>
                
                <div id="portfolio-summary" class="mt-4 p-4 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-700">
                    <div class="text-xs text-blue-200">Portfolio Summary</div>
                    <div id="portfolio-stats" class="text-sm font-medium">
                        <!-- Stats populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- AlphaStack Screener Section -->
            <div class="dashboard-card p-6">
                <div id="alphastack-screener-container">
                    <!-- AlphaStack component will be initialized here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        console.log('üöÄ Trading Dashboard initialized');
        
        // Portfolio Management Functions
        async function loadPortfolio() {
            try {
                console.log('üìä Loading portfolio...');
                const response = await fetch('/api/dashboard');
                const data = await response.json();
                
                const positions = data.portfolio?.positions || [];
                const container = document.getElementById('portfolio-positions');
                
                if (positions.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-blue-300">No positions found</div>';
                    return;
                }
                
                // Render positions
                container.innerHTML = positions.map(pos => `
                    <div class="position-card">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-lg">${pos.symbol}</div>
                                <div class="text-sm text-blue-200">${pos.qty} shares @ $${pos.currentPrice?.toFixed(2)}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold ${pos.unrealizedPnL >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    $${pos.unrealizedPnL?.toFixed(2)}
                                </div>
                                <div class="text-xs ${pos.unrealizedPnL >= 0 ? 'text-green-300' : 'text-red-300'}">
                                    ${pos.unrealizedPnLPercent?.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-400">
                                Risk: ${pos.riskAnalysis?.recommendation || 'HOLD'}
                            </div>
                            <button onclick="executeBuy100('${pos.symbol}', ${pos.currentPrice})" 
                                    class="buy-button text-xs">
                                üí∞ BUY $100
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Update portfolio stats
                const totalValue = positions.reduce((sum, pos) => sum + (pos.marketValue || 0), 0);
                const totalPnL = positions.reduce((sum, pos) => sum + (pos.unrealizedPnL || 0), 0);
                const avgReturn = totalValue > 0 ? (totalPnL / (totalValue - totalPnL)) * 100 : 0;
                
                document.getElementById('portfolio-stats').innerHTML = `
                    <div class="flex justify-between">
                        <span>Total Positions:</span>
                        <span>${positions.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total P&L:</span>
                        <span class="${totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}">
                            $${totalPnL.toFixed(2)}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span>Avg Return:</span>
                        <span class="${avgReturn >= 0 ? 'text-green-400' : 'text-red-400'}">
                            ${avgReturn.toFixed(1)}%
                        </span>
                    </div>
                `;
                
                console.log('‚úÖ Portfolio loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Portfolio load error:', error);
                document.getElementById('portfolio-positions').innerHTML = 
                    `<div class="text-red-400 text-center py-4">Error: ${error.message}</div>`;
            }
        }
        
        // Buy function
        window.executeBuy100 = function(symbol, price) {
            console.log(`üí∞ Execute $100 buy for ${symbol} at $${price}`);
            alert(`Would execute $100 buy order for ${symbol} at $${price}`);
        };
        
        // Portfolio view management
        let currentView = 'basic';
        
        function switchToBasicView() {
            currentView = 'basic';
            document.getElementById('basic-view').className = 'px-3 py-1 rounded text-xs transition-colors bg-blue-600 text-white';
            document.getElementById('enhanced-view').className = 'px-3 py-1 rounded text-xs transition-colors text-gray-300 hover:text-white';
            loadPortfolio();
        }
        
        function switchToEnhancedView() {
            currentView = 'enhanced';
            document.getElementById('enhanced-view').className = 'px-3 py-1 rounded text-xs transition-colors bg-blue-600 text-white';
            document.getElementById('basic-view').className = 'px-3 py-1 rounded text-xs transition-colors text-gray-300 hover:text-white';
            
            if (typeof window.initializeEnhancedPortfolio === 'function') {
                window.initializeEnhancedPortfolio('portfolio-positions');
                console.log('‚úÖ Enhanced portfolio initialized');
            } else {
                console.error('‚ùå Enhanced portfolio not available');
                alert('Enhanced portfolio is not available. Switching back to basic view.');
                switchToBasicView();
            }
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Initializing dashboard components...');
            
            // Load portfolio immediately (basic view by default)
            loadPortfolio();
            
            // Initialize AlphaStack screener
            if (typeof window.initializeAlphaStackScreener === 'function') {
                window.initializeAlphaStackScreener('alphastack-screener-container');
                console.log('‚úÖ AlphaStack screener initialized');
            } else {
                console.error('‚ùå AlphaStack screener not available');
            }
            
            // Portfolio view toggle buttons
            document.getElementById('basic-view')?.addEventListener('click', switchToBasicView);
            document.getElementById('enhanced-view')?.addEventListener('click', switchToEnhancedView);
            
            // Refresh button - adapts to current view
            document.getElementById('refresh-portfolio')?.addEventListener('click', function() {
                if (currentView === 'enhanced' && window.enhancedPortfolio) {
                    window.enhancedPortfolio.loadEnhancedPortfolio();
                } else {
                    loadPortfolio();
                }
            });
            
            console.log('üéâ Dashboard initialization complete');
        });
        
        // Auto-refresh portfolio every 30 seconds - respects current view
        setInterval(function() {
            if (currentView === 'enhanced' && window.enhancedPortfolio) {
                window.enhancedPortfolio.loadEnhancedPortfolio();
            } else {
                loadPortfolio();
            }
        }, 30000);
    </script>
</body>
</html>