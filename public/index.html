<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-green { color: #10b981; }
        .status-yellow { color: #f59e0b; }
        .status-red { color: #ef4444; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-6">
        
        <!-- Header -->
        <div class="glass-effect rounded-2xl p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">üéØ Trading Intelligence Dashboard</h1>
                    <p class="text-blue-200">Unified VIGL Discovery + Portfolio Management</p>
                </div>
                <div class="flex space-x-4">
                    <button id="refreshBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition-colors">
                        üîÑ Refresh
                    </button>
                    <button id="analyzeBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition-colors">
                        üß† Analyze
                    </button>
                </div>
            </div>
            
            <!-- Status Indicators -->
            <div class="flex items-center space-x-6 mt-4 text-sm">
                <div class="flex items-center">
                    <div id="connectionDot" class="w-3 h-3 rounded-full mr-2 pulse-dot status-yellow"></div>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div id="lastUpdated" class="text-blue-200">Last updated: --</div>
                <div id="loadingIndicator" class="hidden">
                    <span class="inline-block animate-spin">‚ö°</span> Loading...
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center mb-2">
                    <div class="text-2xl mr-3">üí∞</div>
                    <div>
                        <div class="text-2xl font-bold" id="totalValue">$--</div>
                        <div class="text-blue-200 text-sm">Portfolio Value</div>
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center mb-2">
                    <div class="text-2xl mr-3">üìà</div>
                    <div>
                        <div class="text-2xl font-bold" id="dailyPnL">$--</div>
                        <div class="text-blue-200 text-sm">Today's P&L</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- VIGL Discoveries -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üîç VIGL Pattern Discoveries</h2>
                        <button id="scanViglBtn" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm transition-colors">
                            Scan Market
                        </button>
                    </div>
                    
                    <div id="viglDiscoveries" class="space-y-4">
                        <div class="text-center text-blue-200 py-8">
                            Click "Scan Market" to discover VIGL patterns...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div>
                <div class="glass-effect rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">üö® Recent Alerts</h2>
                    <div id="recentAlerts" class="space-y-3">
                        <div class="text-center text-blue-200 py-4">
                            No alerts yet...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Positions -->
        <div class="mt-6">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">üìä Portfolio Positions</h2>
                    <button id="analyzePortfolioBtn" class="bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded text-sm transition-colors">
                        Analyze Risk
                    </button>
                </div>
                
                <div id="portfolioPositions" class="space-y-4">
                    <div class="text-center text-blue-200 py-8">
                        Loading portfolio positions...
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Trade Modal -->
    <div id="tradeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modalTitle">Execute Trade</h3>
                <button onclick="closeTradeModal()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-1">Action</label>
                    <div class="text-lg font-bold" id="modalAction">BUY</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-1">Symbol</label>
                    <div class="text-lg font-bold" id="modalSymbol">--</div>
                </div>
                
                <div>
                    <label for="tradeQuantity" class="block text-sm font-medium text-blue-200 mb-1">Quantity</label>
                    <input type="number" id="tradeQuantity" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white" 
                           min="1" max="1000" value="10">
                </div>
                
                <div class="bg-blue-900 bg-opacity-30 rounded p-3">
                    <div class="text-xs text-blue-200">Current Price: <span id="modalPrice">$--</span></div>
                    <div class="text-xs text-blue-200">Estimated Cost: $<span id="estimatedCost">--</span></div>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeTradeModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded transition-colors">
                        Cancel
                    </button>
                    <button onclick="executeTrade()" id="executeBtn" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded font-medium transition-colors">
                        Execute Trade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TradingDashboard {
            constructor() {
                this.data = {};
                this.refreshInterval = null;
                this.initializeEventListeners();
                this.loadDashboard();
                this.startAutoRefresh();
            }

            initializeEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadDashboard());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.runAnalysis());
                document.getElementById('scanViglBtn').addEventListener('click', () => this.scanViglPatterns());
                document.getElementById('analyzePortfolioBtn').addEventListener('click', () => this.analyzePortfolio());
            }

            async loadDashboard() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/dashboard');
                    
                    if (!response.ok) throw new Error('Failed to load dashboard');
                    
                    this.data = await response.json();
                    this.updateUI();
                    this.updateConnectionStatus(this.data.portfolio?.isConnected);
                    
                } catch (error) {
                    console.error('Dashboard load error:', error);
                    this.showError('Failed to load dashboard data');
                    this.updateConnectionStatus(false);
                } finally {
                    this.showLoading(false);
                }
            }

            async runAnalysis() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'both' })
                    });
                    
                    if (!response.ok) throw new Error('Analysis failed');
                    
                    const result = await response.json();
                    this.showSuccess('Analysis complete!');
                    
                    // Refresh dashboard with new data
                    setTimeout(() => this.loadDashboard(), 1000);
                    
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showError('Analysis failed');
                } finally {
                    this.showLoading(false);
                }
            }

            async scanViglPatterns() {
                try {
                    // Check if scan already in progress
                    const statusResponse = await fetch('/api/vigl-status');
                    const status = await statusResponse.json();
                    
                    if (status.scanning) {
                        this.showError('VIGL scan already in progress. Please wait 1-2 minutes for completion.');
                        return;
                    }

                    // Update UI to show scanning state
                    this.showViglScanning(true);
                    this.showSuccess('Starting VIGL pattern analysis... This will take 1-2 minutes to scan thousands of stocks.');
                    
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'vigl' })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'VIGL scan failed');
                    }
                    
                    const result = await response.json();
                    this.data.discoveries = result.discoveries;
                    this.renderViglDiscoveries();
                    
                    if (result.discoveries.length > 0) {
                        this.showSuccess(`‚úÖ VIGL scan complete! Found ${result.discoveries.length} matching patterns.`);
                    } else {
                        this.showSuccess('VIGL scan complete. No patterns found matching criteria.');
                    }
                    
                } catch (error) {
                    console.error('VIGL scan error:', error);
                    this.showError(error.message || 'VIGL scan failed');
                } finally {
                    this.showViglScanning(false);
                }
            }

            showViglScanning(scanning) {
                const container = document.getElementById('viglDiscoveries');
                const scanBtn = document.getElementById('scanViglBtn');
                
                if (scanning) {
                    scanBtn.disabled = true;
                    scanBtn.textContent = '‚è≥ Scanning...';
                    scanBtn.className = 'bg-gray-600 px-3 py-1 rounded text-sm cursor-not-allowed';
                    
                    container.innerHTML = `
                        <div class="text-center text-blue-200 py-8">
                            <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-blue-400 rounded-full mb-4"></div>
                            <div class="text-lg font-bold mb-2">üîç VIGL Pattern Analysis Running</div>
                            <div class="text-sm">Scanning thousands of stocks for volume spikes and momentum patterns...</div>
                            <div class="text-xs text-blue-300 mt-2">‚è±Ô∏è This process takes 1-2 minutes - please don't refresh the page</div>
                            <div class="mt-4 bg-blue-900 bg-opacity-50 rounded-lg p-3">
                                <div class="text-xs">Looking for patterns similar to VIGL's 324% winner:</div>
                                <div class="text-xs">‚Ä¢ 20.9x volume spikes ‚Ä¢ Price momentum ‚Ä¢ Breakout patterns</div>
                            </div>
                        </div>
                    `;
                } else {
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'Scan Market';
                    scanBtn.className = 'bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm transition-colors';
                }
            }

            async analyzePortfolio() {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'portfolio' })
                    });
                    
                    if (!response.ok) throw new Error('Portfolio analysis failed');
                    
                    const result = await response.json();
                    this.data.portfolio = result.portfolio;
                    this.renderPortfolioPositions();
                    this.showSuccess('Portfolio analysis complete!');
                    
                } catch (error) {
                    console.error('Portfolio analysis error:', error);
                    this.showError('Portfolio analysis failed');
                } finally {
                    this.showLoading(false);
                }
            }

            updateUI() {
                if (!this.data.summary) return;

                const { summary } = this.data;
                
                // Update summary cards
                document.getElementById('totalValue').textContent = 
                    `$${summary.totalValue?.toLocaleString() || '--'}`;
                
                document.getElementById('dailyPnL').textContent = 
                    `$${summary.dailyPnL?.toLocaleString() || '--'}`;
                document.getElementById('dailyPnL').className = 
                    `text-2xl font-bold ${summary.dailyPnL >= 0 ? 'status-green' : 'status-red'}`;

                // Update sections
                this.renderViglDiscoveries();
                this.renderPortfolioPositions();
                this.renderRecentAlerts();
                
                // Update timestamp
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date(this.data.lastUpdated).toLocaleTimeString()}`;
            }

            renderViglDiscoveries() {
                const container = document.getElementById('viglDiscoveries');
                const discoveries = this.data.discoveries || [];
                
                if (discoveries.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-8">üìä No VIGL patterns found matching 65%+ similarity criteria<br><br>üîç Click "Scan Market" to scan recent trading days for VIGL patterns</div>';
                    return;
                }
                
                container.innerHTML = discoveries.map(stock => `
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 border-l-4 ${
                        stock.confidence >= 0.8 ? 'border-green-400' : 
                        stock.confidence >= 0.6 ? 'border-yellow-400' : 'border-red-400'
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-bold text-lg">${stock.symbol}</span>
                                    <span class="text-sm bg-blue-600 px-2 py-1 rounded">${stock.sector}</span>
                                    <span class="text-sm font-bold ${
                                        stock.confidence >= 0.8 ? 'status-green' : 
                                        stock.confidence >= 0.6 ? 'status-yellow' : 'status-red'
                                    }">${Math.round(stock.confidence * 100)}% Match</span>
                                </div>
                                <div class="text-sm text-blue-200 mb-2">${stock.name}</div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>Price: $${stock.currentPrice}</div>
                                    <div>Volume: ${stock.volumeSpike}x spike</div>
                                    <div>Momentum: +${stock.momentum.toFixed(1)}%</div>
                                    <div>Upside: ${stock.estimatedUpside}</div>
                                </div>
                                ${stock.catalysts ? `
                                    <div class="text-xs text-blue-300 mt-2">
                                        Catalysts: ${stock.catalysts.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${
                                    stock.recommendation === 'STRONG BUY' ? 'status-green' : 
                                    stock.recommendation === 'BUY' ? 'status-yellow' : 'text-white'
                                }">${stock.recommendation}</div>
                                <div class="text-xs text-blue-200 mb-2">Risk: ${stock.riskLevel}</div>
                                ${stock.recommendation === 'STRONG BUY' || stock.recommendation === 'BUY' ? `
                                    <button onclick="buyStock('${stock.symbol}', 10)" 
                                            class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded text-xs transition-colors">
                                        Buy 10
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            renderPortfolioPositions() {
                const container = document.getElementById('portfolioPositions');
                const positions = this.data.portfolio?.positions || [];
                
                if (positions.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-8">No positions found...</div>';
                    return;
                }
                
                container.innerHTML = positions.map(pos => {
                    // Generate thesis explanation based on WOLF analysis
                    let thesis = '';
                    let actionButtons = '';
                    
                    if (pos.riskAnalysis?.recommendation === 'SELL') {
                        thesis = `High risk detected: ${pos.riskAnalysis.wolfScore >= 0.8 ? 'Extreme' : 'Significant'} downside risk. ${pos.unrealizedPnLPercent < -15 ? 'Large drawdown suggests momentum breakdown.' : 'Risk metrics indicate potential -25% loss if held.'} Consider exit to preserve capital.`;
                        actionButtons = `
                            <button onclick="showTradeModal('sell', '${pos.symbol}', ${Math.min(pos.qty, 10)})" 
                                    class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                                üîª Sell Position
                            </button>`;
                    } else if (pos.riskAnalysis?.recommendation === 'BUY_MORE') {
                        thesis = `Strong opportunity: Low risk (${Math.round(pos.riskAnalysis.wolfScore * 100)}%) + profitable position (${pos.unrealizedPnLPercent.toFixed(1)}% gain). Momentum and risk metrics support adding to winner.`;
                        actionButtons = `
                            <button onclick="showTradeModal('buy', '${pos.symbol}', 10)" 
                                    class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                                üìà Add More
                            </button>`;
                    } else if (pos.riskAnalysis?.recommendation === 'REDUCE') {
                        thesis = `Moderate risk warning: Position showing ${pos.riskAnalysis.wolfScore >= 0.6 ? 'elevated' : 'emerging'} risk signals. ${pos.unrealizedPnLPercent < -10 ? 'Drawdown suggests weakening momentum.' : 'Risk metrics suggest reducing exposure.'} Consider partial exit.`;
                        actionButtons = `
                            <button onclick="showTradeModal('sell', '${pos.symbol}', ${Math.floor(pos.qty / 2)})" 
                                    class="bg-orange-600 hover:bg-orange-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                                ‚öñÔ∏è Reduce Position
                            </button>`;
                    } else {
                        thesis = `Monitor position: Risk levels acceptable (${Math.round(pos.riskAnalysis.wolfScore * 100)}%). ${pos.unrealizedPnLPercent >= 0 ? 'Position profitable - maintain current allocation.' : 'Minor drawdown within normal range - hold for recovery.'}`;
                        actionButtons = `
                            <button onclick="showTradeModal('sell', '${pos.symbol}', ${Math.min(pos.qty, 10)})" 
                                    class="bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded text-sm transition-colors mr-2">
                                Sell
                            </button>
                            <button onclick="showTradeModal('buy', '${pos.symbol}', 5)" 
                                    class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm transition-colors">
                                Buy
                            </button>`;
                    }
                    
                    return `
                    <div class="bg-white bg-opacity-10 rounded-lg p-4 border-l-4 ${
                        pos.riskAnalysis?.wolfScore >= 0.6 ? 'border-red-400' : 
                        pos.riskAnalysis?.wolfScore >= 0.4 ? 'border-yellow-400' : 'border-green-400'
                    }">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-bold text-lg">${pos.symbol}</span>
                                    <span class="text-sm ${pos.unrealizedPnL >= 0 ? 'status-green' : 'status-red'}">
                                        ${pos.unrealizedPnL >= 0 ? '+' : ''}$${pos.unrealizedPnL.toFixed(2)} 
                                        (${pos.unrealizedPnLPercent >= 0 ? '+' : ''}${pos.unrealizedPnLPercent.toFixed(2)}%)
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm mb-2">
                                    <div>Qty: ${pos.qty}</div>
                                    <div>Price: $${pos.currentPrice.toFixed(2)}</div>
                                    <div>Value: $${pos.marketValue.toLocaleString()}</div>
                                    <div>Avg: $${pos.avgEntryPrice.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${
                                    pos.riskAnalysis?.recommendation === 'SELL' ? 'status-red' : 
                                    pos.riskAnalysis?.recommendation === 'BUY_MORE' ? 'status-green' : 
                                    pos.riskAnalysis?.recommendation === 'REDUCE' ? 'status-yellow' : 'text-white'
                                }">${pos.riskAnalysis?.recommendation || 'HOLD'}</div>
                                <div class="text-xs text-blue-200">Risk: ${Math.round((pos.riskAnalysis?.wolfScore || 0) * 100)}%</div>
                            </div>
                        </div>
                        
                        <!-- Thesis Explanation -->
                        <div class="bg-black bg-opacity-20 rounded p-3 mb-3">
                            <div class="text-xs font-bold text-blue-300 mb-1">üìã SYSTEM THESIS:</div>
                            <div class="text-xs text-blue-100">${thesis}</div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex justify-end space-x-2">
                            ${actionButtons}
                        </div>
                    </div>`;
                }).join('');
            }

            renderRecentAlerts() {
                const container = document.getElementById('recentAlerts');
                const alerts = this.data.alerts || [];
                
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="text-center text-blue-200 py-4">No alerts yet...</div>';
                    return;
                }
                
                container.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div class="bg-white bg-opacity-10 rounded-lg p-3 border-l-4 ${
                        alert.severity === 'HIGH' ? 'border-red-400' : 'border-yellow-400'
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-bold text-sm">${alert.title}</div>
                                <div class="text-xs text-blue-200 mt-1">${alert.message}</div>
                            </div>
                            <div class="text-xs text-blue-300">
                                ${new Date(alert.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const status = document.getElementById('connectionStatus');
                
                if (connected) {
                    dot.className = 'w-3 h-3 rounded-full mr-2 pulse-dot status-green';
                    status.textContent = 'Alpaca Connected';
                } else {
                    dot.className = 'w-3 h-3 rounded-full mr-2 pulse-dot status-yellow';
                    status.textContent = 'Mock Data Mode';
                }
            }

            showLoading(show) {
                document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            }

            showSuccess(message) {
                // Simple success notification (could be enhanced with toast library)
                console.log('Success:', message);
            }

            showError(message) {
                console.error('Error:', message);
                // Could show toast notification here
            }

            startAutoRefresh() {
                // Auto-refresh every 60 seconds
                this.refreshInterval = setInterval(() => {
                    this.loadDashboard();
                }, 60000);
            }

            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            }

            async executeTrade(action, symbol, qty) {
                try {
                    this.showLoading(true);
                    const response = await fetch('/api/trade', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, symbol, qty })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showSuccess(`${result.message} - Order ID: ${result.orderId}`);
                        // Refresh dashboard to show updated positions
                        setTimeout(() => this.loadDashboard(), 2000);
                    } else {
                        this.showError(result.error || 'Trade failed');
                    }
                    
                } catch (error) {
                    console.error('Trade execution error:', error);
                    this.showError('Failed to execute trade');
                } finally {
                    this.showLoading(false);
                }
            }
        }

        // Trade Modal Functions
        let currentTradeData = {};

        function showTradeModal(action, symbol, defaultQty) {
            // Find the position data to get current price
            const position = window.dashboard?.data?.portfolio?.positions?.find(p => p.symbol === symbol);
            const currentPrice = position?.currentPrice || 0;
            
            currentTradeData = {
                action: action.toLowerCase(),
                symbol: symbol,
                price: currentPrice
            };
            
            // Update modal content
            document.getElementById('modalTitle').textContent = `${action.toUpperCase()} ${symbol}`;
            document.getElementById('modalAction').textContent = action.toUpperCase();
            document.getElementById('modalAction').className = `text-lg font-bold ${action.toLowerCase() === 'sell' ? 'text-red-400' : 'text-green-400'}`;
            document.getElementById('modalSymbol').textContent = symbol;
            document.getElementById('modalPrice').textContent = `$${currentPrice.toFixed(2)}`;
            document.getElementById('tradeQuantity').value = defaultQty;
            document.getElementById('executeBtn').className = `flex-1 py-2 rounded font-medium transition-colors ${action.toLowerCase() === 'sell' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`;
            document.getElementById('executeBtn').textContent = `${action.toUpperCase()} ${symbol}`;
            
            // Update estimated cost
            updateEstimatedCost();
            
            // Show modal
            document.getElementById('tradeModal').classList.remove('hidden');
            
            // Add quantity change listener
            document.getElementById('tradeQuantity').addEventListener('input', updateEstimatedCost);
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.add('hidden');
            currentTradeData = {};
        }

        function updateEstimatedCost() {
            const quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
            const cost = quantity * (currentTradeData.price || 0);
            document.getElementById('estimatedCost').textContent = cost.toLocaleString();
        }

        async function executeTrade() {
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            if (window.dashboard) {
                closeTradeModal();
                await window.dashboard.executeTrade(currentTradeData.action, currentTradeData.symbol, quantity);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new TradingDashboard();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.dashboard) {
                window.dashboard.stopAutoRefresh();
            }
        });
    </script>
</body>
</html>